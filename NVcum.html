<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Ph√¢n T√≠ch KPI ƒêa Si√™u Th·ªã</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha512-iecdLmaskl7CV0sXU32F/eRj5lWc1BqB0/X/E5eF4/g5C3Z6aLgP4nFf5F5t2VfP4wL2gQJ7g==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root {
            /* B·∫£ng m√†u */
            --primary-accent: #108AB1;
            --success-color: #06D7A0;
            --warning-color: #FFD167;
            --danger-color: #F04770;
            --secondary-accent: #F78C6A;
            --text-primary: #073A4B;
            --text-on-dark: #FFFFFF;
            --text-muted: #5A7A84;
            --bg-main: #F4F7F9;
            --border-main: #DDE3E7;
            --shadow-main: 0 4px 12px rgba(7, 58, 75, 0.08);

            /* Bi·∫øn t∆∞∆°ng th√≠ch */
            --primary-color: var(--primary-accent);
            --card-bg: #FFFFFF;
            
            /* STRAM Colors */
            --d1-color: #F04770;
            --d2-color: #F78C6A;
            --d3-color: #FFD167;
            --d4-color: #06D7A0;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; margin: 0; padding: 20px; background-color: var(--bg-main); color: var(--text-primary); }
        .container { max-width: 100%; padding: 15px; box-sizing: border-box; }
        .inner-container{ max-width: 100%; width: 100%; margin: 0; padding: 0; margin: auto; }
        h1, h2, h3 { color: var(--text-primary); }
        h1 { text-align: center; margin-bottom: 25px; font-weight: 600; }
        h2 { font-size: 1.5em; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--border-main); font-weight: 500;}
        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 25px;
            border: 1px solid var(--border-main);
            box-shadow: var(--shadow-main);
            position: relative;
        }
        
        /* B·ªë c·ª•c nh·∫≠p li·ªáu */
        .input-grid-compact { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px; 
        }
        .input-group-compact {
            display: flex; 
            flex-direction: column; 
            gap: 5px; 
        }
        .input-group-compact h3 {
            font-size: 1.1em;
            margin-bottom: 5px;
        }
        .input-group-compact textarea { 
            width: 100%; 
            height: 80px; 
            font-size: 12px;
        }
        .btn-paste {
            padding: 6px 10px; 
            font-size: 13px;
            font-weight: bold;
            color: var(--text-on-dark);
            background-color: var(--primary-accent);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.2s;
            align-self: flex-start;
        }

        input[type="text"], input[type="number"], textarea, input[type="date"], select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 5px; font-size: 14px; box-sizing: border-box; }
        input:disabled { background-color: #e9ecef; cursor: not-allowed; }
        .btn-group { display: flex; gap: 15px; margin-top: 20px;}
        .btn { display: block; width: 100%; padding: 15px; color: var(--text-on-dark); border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; transition: all 0.3s ease; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);}
        
        .btn:hover, .btn-paste:hover { filter: brightness(90%); }
        .btn.btn-inline { display: inline-block; width: auto; font-size: 16px; padding: 12px 20px; }
        .btn.btn-small { width: auto; font-size: 14px; padding: 8px 15px; }
        #processBtn { background-color: var(--primary-accent); }
        #captureReportBtnMain { background-color: var(--primary-accent); }
        #captureComprehensiveBtn { background-color: var(--primary-accent); }
        #editDataBtn { background-color: var(--text-muted); margin-right: 10px; }
        
        /* CONTEST SELECTOR GROUP */
        #contestSelectorGroup { display: flex; align-items: center; padding: 5px 10px; border-radius: 8px; background-color: var(--bg-main); border: 1px solid var(--border-main); }
        #allContestsCheckbox { margin-right: 10px; width: 18px; height: 18px; accent-color: var(--success-color); }
        #selectContestsBtnCustom { background-color: var(--secondary-accent); color: var(--text-on-dark); border-radius: 8px; font-weight: bold; padding: 10px 15px; cursor: pointer; border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        #contestCountStatus { margin-left: 10px; font-size: 14px; color: var(--text-muted); font-weight: 500; }

        #captureCardsBtn { background-color: var(--secondary-accent); }
        #captureAllCardsBtn { background-color: var(--success-color); margin-left: 15px; }
        #copyCommentsBtn { background-color: var(--primary-accent); }
        
        /* Target Allocation Styles */
        .target-allocation-container { border: 1px solid var(--border-main); border-radius: 8px; padding: 15px; background-color: #fff; margin-top: 15px; }
        .target-mode-switch { display: flex; gap: 20px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px dashed var(--border-main); }
        .target-mode-label { display: flex; align-items: center; cursor: pointer; font-weight: 500; }
        .target-mode-label input { width: 18px; height: 18px; margin-right: 8px; accent-color: var(--primary-accent); }
        .employee-list-header { display: grid; grid-template-columns: 40px 2fr 1fr 1.5fr; font-weight: bold; padding: 8px 0; background-color: #f8f9fa; border-bottom: 2px solid var(--border-main); text-align: center; }
        .employee-target-row { display: grid; grid-template-columns: 40px 2fr 1fr 1.5fr; padding: 8px 0; border-bottom: 1px solid #eee; align-items: center; }
        .employee-target-row input[type="checkbox"] { width: 18px; height: 18px; margin: auto; accent-color: var(--success-color); }
        .employee-target-row input[type="number"] { width: 80%; padding: 5px; text-align: center; margin: auto; }
        .employee-target-val { font-weight: bold; color: var(--primary-accent); text-align: right; padding-right: 15px; }
        .employee-name-label { padding-left: 10px; font-weight: 500; }

        .table-container { overflow-x: auto; margin-top: 25px;}
        .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: var(--danger-color); color: var(--text-on-dark); padding: 15px 25px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; font-weight: 500; }
        .toast.show { opacity: 1; visibility: visible; }
        
        #reportTitle { text-align: center; margin: 20px 0 0 0; display: none;}
        .section-header { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; }
        .section-header > div { display: flex; gap: 10px; }
        
        /* GIAO DI·ªÜN B·∫¢NG T·ªîNG H·ª¢P */
        .comprehensive-table { width: 100%; border-collapse: collapse; font-size: 11px; }
        .comprehensive-table th, .comprehensive-table td { border: 1px solid var(--border-main); padding: 6px 3px; text-align: center; vertical-align: middle; }
        .comprehensive-table thead th { background-color: #F9FAFB; font-weight: 600; position: sticky; top: 0; z-index: 1; }
        .comprehensive-table th:first-child, .comprehensive-table td:first-child { position: sticky; left: 0; background-color: #fff; z-index: 2; width: 40px; min-width: 40px; }
        .comprehensive-table th:nth-child(2), .comprehensive-table td:nth-child(2) { position: sticky; left: 40px; background-color: #fff; z-index: 2; min-width: 100px; width: 100px; }
        .comprehensive-table td:nth-child(2) { text-align: left; font-weight: 600; }
        .clickable-name, .clickable-header { color: var(--primary-accent); font-weight: 700; cursor: pointer; text-decoration: none; }
        .clickable-name:hover, .clickable-header:hover { text-decoration: underline; }
        .rank-cell { font-weight: 700; font-size: 1.0em; }
        .heatmap-cell { color: var(--text-primary); font-size: 11px; vertical-align: middle; }
        
        .percent-badge { display: inline-block; padding: 3px 8px; border-radius: 15px; font-weight: 700; font-size: 1.0em; border: 2px solid; min-width: 45px; text-align: center; }
        .sub-target-display { display: block; font-size: 0.9em; color: var(--text-muted); margin-top: 4px; font-weight: 500; }
        .badge-green { background-color: rgba(6, 215, 160, 0.1); border-color: var(--success-color); color: var(--success-color); }
        .badge-red { background-color: rgba(240, 71, 112, 0.1); border-color: var(--danger-color); color: var(--danger-color); }
        
        .progress-bar-wrapper { min-width: 110px; }
        .progress-bar-label { display: flex; justify-content: space-between; align-items: center; font-size: 10px; margin-bottom: 4px; font-weight: 500; color: var(--text-muted);}
        .progress-bar-bg { background-color: #e9ecef; border-radius: 50px; height: 8px; overflow: hidden;}
        .progress-bar-fill { background-color: var(--primary-color); height: 100%; border-radius: 50px; transition: width 0.5s ease-in-out; }
        .progress-bar-fill.success { background-color: var(--success-color); }

        .contest-header-cell { max-width: 70px; min-width: 60px; white-space: normal; font-size: 10px; vertical-align: top; padding: 6px 3px; }
        .contest-header-cell > div { margin-top: 5px; font-size: 1.0em; font-weight: 700; }

        /* Modal Styles */
        .modal { display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); padding-top: 50px; }
        .modal-content { background-color: var(--bg-main); margin: auto; padding: 20px; border: 1px solid #888; width: 95%; max-width: 1400px; border-radius: 12px; position: relative; box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19); }
        .modal-close-btn { color: #aaa; position: absolute; top: 10px; right: 25px; font-size: 35px; font-weight: bold; cursor: pointer; z-index: 1002; }
        .modal .data-table { font-size: 14px; width: 100%; border-collapse: collapse; }
        .modal .data-table th, .modal .data-table td { padding: 12px 10px; border: 1px solid var(--border-main); text-align: center; }
        .modal .data-table thead th { background-color: #F9FAFB; }
        
        /* Modal Contest Selection */
        #contest-selection-modal .modal-content { max-width: 600px; }
        #contest-list { max-height: 250px; overflow-y: auto; border: 1px solid var(--border-main); padding: 15px; border-radius: 8px; background-color: #fff; }
        .contest-item { display: flex; align-items: center; padding: 8px 0; border-bottom: 1px dashed #eee; cursor: pointer; font-size: 15px; font-weight: 500; }
        .contest-item:last-child { border-bottom: none; }
        .contest-item input[type="checkbox"] { margin-right: 15px; width: 18px; height: 18px; accent-color: var(--primary-accent); pointer-events: none; }
        .contest-item label { flex-grow: 1; cursor: pointer; pointer-events: none; }

        /* GIAO DI·ªÜN Th·∫ª KPI */
        #allCardsContainer { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; }
        .perf-card { border-radius: 10px; overflow: hidden; background: white; border: 1px solid var(--border-main); display: flex; flex-direction: column; height: 100%; box-shadow: var(--shadow-main); position: relative; }
        .perf-header { display: grid; grid-template-columns: 80px minmax(0, 1fr) auto; background: var(--text-primary); color: var(--text-on-dark); padding: 15px; align-items: center; gap: 15px;}
        .perf-header .perf-avatar { width: 60px; height: 60px; }
        .perf-header .name-block h2 { margin: 0; font-size: 1.4em; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        .perf-quote { font-size: 13px; opacity: 0.9; margin: 4px 0 0 0; font-style: italic; border-top: 1px solid rgba(255, 255, 255, 0.4); padding-top: 6px; font-weight: 500; }
        .perf-header .rank-block { text-align: right; }
        .perf-header .rank-block h3 { margin: 0; font-size: 1.5em; color: var(--warning-color); }
        
        .perf-body { padding: 20px; flex-grow: 1; }
        .progress-bar-group { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; text-align: center; font-size: 12px; margin-top:20px; }
        .progress-bar-group > div { padding: 8px 5px; border-radius: 8px; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .progress-bar-group .label { color: rgba(255, 255, 255, 0.85); font-weight: 500; font-size: 11px; }
        .progress-bar-group .value { color: white; font-size: 1.25em; margin-top: 4px; display: block; font-weight: 700; }
        .progress-bar-group > div:nth-child(1) { background-color: var(--primary-accent); }
        .progress-bar-group > div:nth-child(2) { background-color: var(--secondary-accent); }
        .progress-bar-group > div:nth-child(3) { background-color: var(--danger-color); }
        .progress-bar-group > div:nth-child(4) { background-color: var(--success-color); }
        .progress-bar-group > div:nth-child(5) { background-color: var(--text-muted); }

        .comparison-change { display: inline-block; margin-left: 5px; font-size: 0.9em; font-weight: 700; }
        .change-up { color: var(--success-color); }
        .change-down { color: var(--danger-color); }
        .change-equal { color: var(--text-muted); }

        .contest-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
        .contest-table th, .contest-table td { border: 1px solid var(--border-main); padding: 8px 6px; text-align: center; vertical-align: middle; }
        .contest-table th { background-color: #f2f3f7; font-weight: 600; font-size: 12px; }
        .contest-table tbody tr:nth-child(even) { background-color: #f8f9fa; }
        .contest-table tbody td:nth-child(2) { font-size: 10px; font-weight: normal; text-align: left; }
        .contest-table .kpi-actual > span { font-weight: 600; display: flex; align-items: center; justify-content: center; gap: 5px; width: 100%; } 
        
        .text-success { color: var(--success-color) !important; font-weight: 700; }
        .text-warning { color: var(--warning-color) !important; font-weight: 700; }
        .text-danger { color: var(--danger-color) !important; font-weight: 700; }
        .icon-cell { font-size: 1.2em; font-weight: 700; color: var(--success-color); }
        .success-text { color: var(--success-color); } 

        /* Controls */
        #comparison-controls { display: flex; align-items: center; gap: 8px; padding: 5px 0; margin-bottom: 0; flex-wrap: nowrap; overflow-x: auto; height: 34px; }
        #comparison-controls label { font-size: 12px; font-weight: 500; color: var(--text-muted); white-space: nowrap; margin-right: -4px; }
        #comparison-controls input[type="date"] { padding: 6px 8px; width: 100px; min-width: 100px; font-size: 12px; }
        #comparison-controls .btn-small { height: 34px; padding: 0 10px; margin-top: 0; font-size: 12px; white-space: nowrap; }
        #runComparisonBtn { background-color: var(--primary-accent); }
        #toggleComparisonBtn { background-color: var(--danger-color); }
        
        .leaderboard-controls-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; overflow-x: auto; padding-bottom: 10px; margin-top: 15px; border-bottom: 1px solid var(--border-main); gap: 10px; }
        .leaderboard-controls-row > div { display: flex; gap: 8px; flex-shrink: 0; align-items: center; }
        .capture-group { padding-left: 10px; border-left: 1px solid var(--border-main); }
        
        @media (max-width: 1024px) {
             .leaderboard-controls-row { flex-wrap: wrap; }
             .leaderboard-controls-row > div { flex-grow: 1; min-width: 100%; margin-top: 10px; gap: 5px; }
             .leaderboard-controls-row .capture-group { border-left: none; padding-left: 0; margin-top: 15px; }
             #comparison-controls { flex-wrap: wrap; height: auto; }
        }
        
        /* STRAM STYLES */
        .stram-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .stram-table th, .stram-table td { border: 1px solid var(--border-main); padding: 10px 8px; text-align: center; vertical-align: middle; }
        .stram-table thead th { background-color: #F9FAFB; font-weight: 600; }
        .stram-table td:nth-child(2) { text-align: left; font-weight: 600; }
        .d-level-badge { display: inline-block; padding: 4px 10px; border-radius: 15px; font-weight: 700; color: var(--text-primary); font-size: 1.1em; border: 2px solid; }
        .d1 { background-color: rgba(240, 71, 112, 0.1); border-color: var(--d1-color); color: var(--d1-color); }
        .d2 { background-color: rgba(247, 140, 106, 0.1); border-color: var(--d2-color); color: var(--d2-color); }
        .d3 { background-color: rgba(255, 209, 103, 0.1); border-color: var(--d3-color); color: var(--d3-color); }
        .d4 { background-color: rgba(6, 215, 160, 0.1); border-color: var(--d4-color); color: var(--d4-color); }
        .s-level-badge { display: inline-block; padding: 4px 10px; border-radius: 15px; font-weight: 700; color: #fff; font-size: 1.1em; }
        .s1 { background-color: var(--d1-color); }
        .s2 { background-color: var(--d2-color); }
        .s3 { background-color: var(--d3-color); color: var(--text-primary); }
        .s4 { background-color: var(--d4-color); color: var(--text-primary); }
        .btn-stram-detail { background-color: var(--primary-accent); color: white; padding: 6px 12px; border-radius: 5px; font-weight: bold; font-size: 13px; cursor: pointer; border: none; }
        
        /* NEW STRAM STYLES FROM NV.HTML */
        .stram-progress-bar-bg { background-color: #e9ecef; border-radius: 50px; height: 6px; overflow: hidden; margin-top: 5px; }
        .stram-progress-bar-fill { height: 100%; border-radius: 50px; transition: width 0.5s ease-in-out; }
        .stram-progress-bar-fill.success { background-color: var(--success-color); }
        .stram-progress-bar-fill.danger { background-color: var(--danger-color); }
        .stram-task-details { font-size: 12px; color: var(--text-muted); margin-top: 8px; padding-top: 8px; border-top: 1px dashed var(--border-main); display: grid; grid-template-columns: 1fr 1fr; gap: 4px 10px; }
        .stram-task-details > div { display: flex; justify-content: space-between; }
        .stram-task-details .label { font-weight: 500; color: var(--text-primary); }
        .stram-task-details .value { font-weight: 700; }
        .stram-task-details .value.green { color: var(--success-color); }
        .stram-task-details .value.red { color: var(--danger-color); }

        /* STRAM Modal */
        #stram-modal .modal-content { max-width: 1200px; }
        .stram-modal-grid { display: grid; grid-template-columns: 350px 1fr; gap: 25px; }
        .stram-leader-card { background: white; padding: 20px; border-radius: 10px; border: 1px solid var(--border-main); }
        .stram-leader-card h3 { margin-top: 0; color: var(--text-primary); border-bottom: 1px solid var(--border-main); padding-bottom: 10px; }
        .stram-leader-card h4 { color: var(--primary-accent); margin-bottom: 8px; }
        .stram-leader-card ul { padding-left: 20px; margin-top: 0; font-size: 14px; color: var(--text-muted); }
        .stram-tabs { display: flex; gap: 5px; border-bottom: 2px solid var(--border-main); margin-bottom: 20px; }
        .stram-tab-btn { padding: 10px 20px; cursor: pointer; background: #f0f0f0; border: none; border-radius: 8px 8px 0 0; font-size: 16px; font-weight: 600; color: var(--text-muted); border-bottom: 2px solid transparent; margin-bottom: -2px; }
        .stram-tab-btn.active { background: white; color: var(--primary-accent); border: 2px solid var(--border-main); border-bottom: 2px solid white; }
        .stram-tab-content { display: none; background: white; padding: 20px; border-radius: 0 10px 10px 10px; border: 1px solid var(--border-main); border-top: none; }
        .stram-tab-content.active { display: block; }
        .stram-task-table { width: 100%; border-collapse: collapse; font-size: 14px; }
        .stram-task-table th, .stram-task-table td { border: 1px solid var(--border-main); padding: 10px; text-align: center; vertical-align: middle; }
        .stram-task-table th { background-color: #F9FAFB; }
        .stram-task-table td:nth-child(1) { text-align: left; font-weight: 500;}

        /* MULTI-STORE & TABS STYLES */
        .store-selector-container { margin-bottom: 0; padding: 15px; background-color: #f0f7ff; border-radius: 8px 8px 0 0; border: 1px solid #cce5ff; border-bottom: none; display: flex; align-items: center; gap: 15px; }
        .store-selector-container label { font-weight: 600; }
        .store-selector-container select { width: auto; font-weight: bold; }
        
        .input-tabs-container { display: flex; gap: 5px; margin-bottom: 0; border-bottom: 1px solid #cce5ff; padding: 0 15px; background-color: #f0f7ff; overflow-x: auto; }
        .input-tab-btn { padding: 10px 20px; cursor: pointer; background: rgba(255,255,255,0.6); border: 1px solid transparent; border-bottom: none; border-radius: 8px 8px 0 0; font-size: 14px; font-weight: 600; color: var(--text-muted); white-space: nowrap; transition: all 0.2s; }
        .input-tab-btn:hover { background-color: rgba(255,255,255,0.9); }
        .input-tab-btn.active { background: #fff; color: var(--primary-accent); border: 1px solid var(--border-main); border-bottom: 2px solid #fff; margin-bottom: -1px; font-weight: 700; box-shadow: 0 -2px 5px rgba(0,0,0,0.05); z-index: 10; }
        
        .input-content-wrapper { border: 1px solid var(--border-main); border-top: none; border-radius: 0 0 8px 8px; background: #fff; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .input-tab-content { display: none; padding: 20px; animation: fadeIn 0.3s; }
        .input-tab-content.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .report-tabs { display: flex; gap: 5px; margin-bottom: 0; padding: 0 10px; overflow-x: auto; }
        .report-tab-btn { padding: 10px 20px; cursor: pointer; background: #e9ecef; border: 1px solid var(--border-main); border-bottom: none; border-radius: 8px 8px 0 0; font-size: 15px; font-weight: 600; color: var(--text-muted); white-space: nowrap; }
        .report-tab-btn.active { background: var(--bg-main); color: var(--primary-accent); border-top: 3px solid var(--primary-accent); font-weight: 700; }
        .report-tab-btn:hover { background-color: #dee2e6; }
    </style>
</head>
<body onload="initDashboard()">
    <div class="container">
        <div class="inner-container">
            
            <div id="report-header" style="display: none; align-items: center; justify-content: space-between; margin-bottom: 25px;">
                <h1 style="margin: 0; text-align: left;">B√°o c√°o Ph√¢n t√≠ch Hi·ªáu su·∫•t</h1>
                <div>
                     <button id="editDataBtn" class="btn btn-inline">Ch·ªânh s·ª≠a D·ªØ li·ªáu</button>
                </div>
            </div>

            <div class="card" id="data-input-card">
                 <h1 style="margin-top:0;">Dashboard ƒê√°nh gi√° Hi·ªáu su·∫•t ƒêa Si√™u Th·ªã</h1>
                
                 <details class="import-export-data" style="margin-bottom: 25px; border-bottom: 1px dashed var(--border-main); padding-bottom: 15px;">
                    <summary style="font-weight: bold; cursor: pointer; color: var(--primary-accent); font-size: 1.2em;">
                        <i class="fas fa-database" style="margin-right: 8px;"></i> Nh·∫≠p/Xu·∫•t To√†n b·ªô D·ªØ li·ªáu (Backup)
                    </summary>
                    <div style="padding: 10px 0;">
                        <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Sao ch√©p m√£ d∆∞·ªõi ƒë√¢y ƒë·ªÉ l∆∞u tr·ªØ ho·∫∑c d√°n m√£ v√†o ƒë·ªÉ kh√¥i ph·ª•c:</p>
                        <textarea id="allDataImportExportData" style="width: 100%; height: 120px; font-size: 12px; font-family: 'Courier New', Courier, monospace;"></textarea>
                        <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: space-between;">
                            <button id="exportAllDataBtn" class="btn btn-small" style="background-color: var(--text-muted); width: 48%;">Xu·∫•t (Sao ch√©p)</button>
                            <button id="importAllDataBtn" class="btn btn-small" style="background-color: var(--primary-accent); width: 48%;">Nh·∫≠p (√Åp d·ª•ng)</button>
                        </div>
                    </div>
                </details>
                
                <div class="store-selector-container">
                    <label for="storeCountSelector"><i class="fas fa-store"></i> Ch·ªçn s·ªë l∆∞·ª£ng Si√™u th·ªã/C·ª•m:</label>
                    <select id="storeCountSelector" onchange="renderStoreInputs(this.value)">
                        <option value="1">1 Si√™u th·ªã</option>
                        <option value="2">2 Si√™u th·ªã</option>
                        <option value="3">3 Si√™u th·ªã</option>
                        <option value="4">4 Si√™u th·ªã</option>
                        <option value="5">5 Si√™u th·ªã</option>
                        <option value="6">6 Si√™u th·ªã</option>
                        <option value="7">7 Si√™u th·ªã</option>
                        <option value="8">8 Si√™u th·ªã</option>
                        <option value="9">9 Si√™u th·ªã</option>
                        <option value="10">10 Si√™u th·ªã</option>
                    </select>
                </div>

                <div id="dynamic-inputs-container">
                    </div>

                <div class="btn-group">
                    <button id="processBtn" class="btn">T·∫°o B√°o C√°o Ph√¢n T√≠ch</button>
                </div>
            </div>
            
            <div id="report-capture-area">
                <h2 id="reportTitle"></h2>
                
                <div id="report-tabs-container" class="report-tabs" style="display: none;"></div>

                <div id="month-progress-container" class="card" style="display: none; padding: 15px 25px; margin-bottom: 25px; margin-top: 0;"></div>

                <div id="results-wrapper" style="display: none;">
                    <div class="card">
                        <div class="section-header">
                            <h2 style="color:var(--primary-accent); margin-bottom: 0; border: none;"> B·∫£ng X·∫øp H·∫°ng T·ªïng H·ª£p</h2>
                             <div class="leaderboard-controls-row">
                                <div id="contestSelectorGroup">
                                    <input type="checkbox" id="allContestsCheckbox">
                                    <label for="allContestsCheckbox" style="cursor: pointer; font-weight: 500; white-space: nowrap;">Hi·ªÉn th·ªã T·∫§T C·∫¢ Ng√†nh h√†ng</label>
                                    <button id="selectContestsBtnCustom" class="btn btn-small">Ch·ªçn Ng√†nh h√†ng</button>
                                    <span id="contestCountStatus">(0/0 nh√≥m)</span>
                                </div>
                                <div id="comparison-controls">
                                    <label for="comparisonStartDate">Bƒê:</label>
                                    <input type="date" id="comparisonStartDate" class="date-input">
                                    <label for="comparisonEndDate">KT:</label>
                                    <input type="date" id="comparisonEndDate" class="date-input">
                                    <button id="runComparisonBtn" class="btn btn-small">So s√°nh</button>
                                    <button id="toggleComparisonBtn" class="btn btn-small" style="display: none;">·∫®n So s√°nh</button>
                                </div>
                                <div class="capture-group">
                                    <button id="captureComprehensiveBtn" class="btn btn-small">Ch·ª•p To√†n B·∫£ng</button>
                                </div>
                            </div>
                        </div>
                        <div id="comprehensiveLeaderboardContainer" class="table-container" style="margin-top:15px; max-height: 85vh; overflow-x: auto;"></div>
                    </div>
                    
                    <div class="card" id="stram-analysis-card">
                        <div class="section-header">
                            <h2 style="color:var(--primary-accent); margin-bottom: 0; border: none;">üî• Chu·∫©n ƒëo√°n STRAM & Phong c√°ch L√£nh ƒë·∫°o</h2>
                        </div>
                        <div id="stramAnalysisContainer" class="table-container" style="margin-top:15px;"></div>
                    </div>

                    <div id="kpi-cards-section">
                         <div class="card">
                            <div class="section-header">
                                <h2 style="color:var(--primary-color); margin-bottom: 0;">üßë‚Äçüíª Ph√¢n t√≠ch Chi ti·∫øt Hi·ªáu su·∫•t C√° nh√¢n</h2>
                                <div style="display: flex; gap: 10px;">
                                    <button id="captureCardsBtn" class="btn btn-small">Ch·ª•p Th·∫ª KPI</button>
                                    <button id="captureAllCardsBtn" class="btn btn-small">Ch·ª•p T·∫•t C·∫£ KPI</button>
                                </div>
                            </div>
                            <div id="allCardsContainer"></div>
                        </div>
                    </div>

                    <div class="card" id="comments-card">
                        <div id="comments-section">
                             <div class="section-header" style="padding-bottom: 10px; border-bottom: 1px solid var(--border-main); margin-bottom: 15px;">
                                <h3 style="margin:0; font-size: 1.2em;">üìã Nh·∫≠n x√©t (D·∫°ng vƒÉn b·∫£n)</h3>
                                <button id="copyCommentsBtn" class="btn btn-small">Sao ch√©p Nh·∫≠n x√©t</button>
                             </div>
                             <textarea id="comments-textarea" readonly style="width: 100%; height: 200px; font-family: 'Courier New', Courier, monospace; background-color: #f8f9fa; border: 1px solid #ccc; border-radius: 5px; padding: 10px; resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
            </div>
            
            </div>
    </div>
    
    <div id="toast-notification" class="toast"></div>
    
    <div id="kpi-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" data-modal-id="kpi-modal">&times;</span>
            <div id="modal-body"></div>
        </div>
    </div>
    
    <div id="stram-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" data-modal-id="stram-modal">&times;</span>
            <h2 id="stram-modal-title" style="margin-top:0; color: var(--primary-accent);"></h2>
            <div id="stram-modal-body"></div>
        </div>
    </div>
    <div id="contest-selection-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close-btn" data-modal-id="contest-selection-modal">&times;</span>
            <h2 style="margin-top:0; color: var(--primary-accent);">Ch·ªçn Ng√†nh h√†ng Thi ƒëua</h2>
            <details class="import-export-panel" open style="margin-bottom: 20px;">
                <summary style="font-weight: bold; cursor: pointer; color: var(--text-primary); padding: 5px 0;">
                    <i class="fas fa-folder-open" style="margin-right: 8px; color: var(--secondary-accent);"></i> Nh·∫≠p/Xu·∫•t Danh s√°ch (Click ƒë·ªÉ m·ªü)
                </summary>
                <div style="padding: 10px 0;">
                    <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 8px;">Sao ch√©p m√£ d∆∞·ªõi ƒë√¢y ƒë·ªÉ chia s·∫ª ho·∫∑c d√°n m√£ v√†o ƒë·ªÉ nh·∫≠p danh s√°ch:</p>
                    <textarea id="contestImportExportData" style="width: 100%; height: 80px; font-size: 12px; font-family: 'Courier New', Courier, monospace;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 10px; justify-content: space-between;">
                        <button id="exportContestBtn" class="btn btn-small" style="background-color: var(--text-muted); width: 30%;">Sao ch√©p (Xu·∫•t)</button>
                        <button id="importContestBtn" class="btn btn-small" style="background-color: var(--success-color); width: 30%;">√Åp d·ª•ng (Nh·∫≠p)</button>
                        <button id="applyContestSelectionBtn" class="btn btn-small" style="background-color: var(--primary-accent); width: 30%;">√Åp d·ª•ng B·ªô l·ªçc</button>
                    </div>
                </div>
            </details>
            <div style="margin-bottom: 15px;">
                <div class="contest-item">
                    <input type="checkbox" id="modalSelectAllContests" onclick="event.stopPropagation(); toggleAllModalContests(this.checked);">
                    <label for="modalSelectAllContests" style="font-weight: bold; color: var(--primary-accent);">**Ch·ªçn t·∫•t c·∫£**</label>
                </div>
            </div>
            <div id="contest-list">
                </div>
        </div>
    </div>

    <script>
    // GLOBAL STATE
    var allStoresData = []; 
    var currentStoreIndex = 1; 
    var finalData = []; 
    
    var allContestHeadersGlobal = []; 
    var selectedContestHeaders = []; 
    var sortedContestHeadersGlobal = []; 
    
    var detectedEmployeesMap = {}; 
    var detectedEmployees = []; 

    var comparisonResultsCache = null;

    // --- KH·ªûI T·∫†O ---
    function initDashboard() {
        const savedStoreCount = localStorage.getItem('storeCountSelector');
        if (savedStoreCount) {
            document.getElementById('storeCountSelector').value = savedStoreCount;
        }

        renderStoreInputs(document.getElementById('storeCountSelector').value);

        const savedContests = localStorage.getItem('selectedContestHeaders');
        if (savedContests) selectedContestHeaders = JSON.parse(savedContests);
        
        const allContestsCheckbox = localStorage.getItem('allContestsCheckbox');
        if (allContestsCheckbox === 'true') {
            const cb = document.getElementById('allContestsCheckbox');
            if(cb) cb.checked = true;
        }

        const startDateEl = document.getElementById('comparisonStartDate');
        if (!startDateEl.value) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            startDateEl.value = formatDate(yesterday);
        }
        document.getElementById('comparisonEndDate').value = getTodayDateString();

        document.getElementById('processBtn').addEventListener('click', () => processData(false));
        document.getElementById('editDataBtn').addEventListener('click', showInputCard);
        document.getElementById('captureComprehensiveBtn').addEventListener('click', captureFullTable);
        document.getElementById('captureCardsBtn').addEventListener('click', captureAllIndividualCards);
        document.getElementById('captureAllCardsBtn').addEventListener('click', () => captureAndDownload(document.getElementById('kpi-cards-section'), `TatCa_KPI_ST${currentStoreIndex}.png`));
        document.getElementById('copyCommentsBtn').addEventListener('click', copyComments);
        
        document.getElementById('exportContestBtn').addEventListener('click', exportContestSelection);
        document.getElementById('importContestBtn').addEventListener('click', importContestSelection);
        document.getElementById('exportAllDataBtn').addEventListener('click', exportAllData);
        document.getElementById('importAllDataBtn').addEventListener('click', importAllData);
        
        document.getElementById('runComparisonBtn').addEventListener('click', runComparison);
        document.getElementById('toggleComparisonBtn').addEventListener('click', toggleComparisonDisplay);
        document.getElementById('applyContestSelectionBtn').addEventListener('click', applyContestSelection);
        document.getElementById('selectContestsBtnCustom').addEventListener('click', showContestSelectionModal);
        
        document.getElementById('allContestsCheckbox').addEventListener('change', (e) => {
            localStorage.setItem('allContestsCheckbox', e.target.checked);
            if (allStoresData.length > 0) {
                showToast(e.target.checked ? 'ƒê√£ ch·ªçn hi·ªÉn th·ªã T·∫§T C·∫¢. ƒêang c·∫≠p nh·∫≠t...' : 'ƒê√£ b·ªè ch·ªçn T·∫§T C·∫¢. ƒêang c·∫≠p nh·∫≠t...');
                processData(true);
            }
        });
        
        document.querySelectorAll('.modal-close-btn').forEach(btn => {
            btn.onclick = () => { document.getElementById(btn.dataset.modalId).style.display = "none"; };
        });
        window.onclick = (event) => {
            if (event.target.classList.contains('modal')) event.target.style.display = "none";
        };

        updateContestStatusUI();
    }

    // --- LOGIC ƒêA SI√äU TH·ªä ---

    function renderStoreInputs(count) {
        localStorage.setItem('storeCountSelector', count);
        const container = document.getElementById('dynamic-inputs-container');
        container.innerHTML = ''; 

        // 1. Tab Headers
        let tabsHtml = '<div class="input-tabs-container">';
        for (let i = 1; i <= count; i++) {
            tabsHtml += `<button class="input-tab-btn ${i === 1 ? 'active' : ''}" onclick="switchInputTab(${i})" id="input-tab-btn-${i}">Si√™u th·ªã ${i}</button>`;
        }
        tabsHtml += '</div>';

        // 2. Tab Content
        let contentHtml = '<div class="input-content-wrapper">';
        for (let i = 1; i <= count; i++) {
            contentHtml += `
                <div class="input-tab-content ${i === 1 ? 'active' : ''}" id="input-tab-content-${i}">
                    <div class="input-grid-compact">
                        <div class="input-group-compact">
                            <h3>B·∫£ng 2: Target Thi ƒëua (ST ${i})</h3>
                            <textarea id="dataInput2_${i}"></textarea>
                            <button class="btn-paste" data-target="dataInput2_${i}" data-filter="table2">D√°n & L·ªçc</button>
                        </div>
                        <div class="input-group-compact">
                            <h3>B·∫£ng 6: Doanh thu (ST ${i})</h3>
                            <textarea id="dataInput6_${i}"></textarea>
                            <button class="btn-paste" data-target="dataInput6_${i}" data-filter="table6">D√°n & L·ªçc</button>
                        </div>
                        <div class="input-group-compact">
                            <h3>B·∫£ng 7: D·ªØ li·ªáu Thi ƒëua (ST ${i})</h3>
                            <textarea id="dataInput7_${i}"></textarea>
                            <button class="btn-paste" data-target="dataInput7_${i}" data-filter="table7">D√°n & L·ªçc</button>
                        </div>
                    </div>
                    
                    <div class="grid-container" style="margin-top: 15px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                        <div>
                            <h3>Target Si√™u th·ªã ${i} (Tri·ªáu)</h3>
                            <input type="text" id="storeTargetInput_${i}" onkeyup="updateEmployeeTargets(${i})" placeholder="Nh·∫≠p s·ªë ti·ªÅn (VD: 5000)" />
                        </div>
                        <div>
                            <h3>L∆∞u Hi·ªáu su·∫•t (ST ${i})</h3>
                            <button id="saveDailyBtn_${i}" class="btn btn-small" style="background-color: var(--secondary-accent); width: 100%; margin-top: 5px;" onclick="saveStoreDaily(${i})">L∆∞u Hi·ªáu su·∫•t Ng√†y Hi·ªán t·∫°i</button>
                        </div>
                    </div>

                    <div class="target-allocation-container">
                        <h3 style="margin-bottom: 10px;">Ph√¢n b·ªï Target Nh√¢n vi√™n (ST ${i})</h3>
                         <div class="target-mode-switch">
                            <label class="target-mode-label">
                                <input type="radio" name="targetMode_${i}" value="even" checked onchange="renderEmployeeTargetList(${i})"> Chia ƒë·ªÅu
                            </label>
                            <label class="target-mode-label">
                                <input type="radio" name="targetMode_${i}" value="custom" onchange="renderEmployeeTargetList(${i})"> T√πy ch·ªânh %
                            </label>
                        </div>
                        <div class="employee-list-header">
                            <div><input type="checkbox" checked onchange="toggleAllEmployees(${i}, this.checked)"></div>
                            <div style="text-align: left; padding-left: 10px;">T√™n Nh√¢n vi√™n</div>
                            <div>T·ª∑ l·ªá (%)</div>
                            <div style="text-align: right; padding-right: 15px;">Target (Tr)</div>
                        </div>
                        <div id="employee-target-list-${i}" style="max-height: 300px; overflow-y: auto;">
                            <div style="padding: 20px; text-align: center; color: #aaa;">D√°n B·∫£ng 6/7 ƒë·ªÉ t·∫£i danh s√°ch.</div>
                        </div>
                        <div style="text-align: right; padding-top: 10px; font-weight: bold; color: var(--text-primary);">
                            T·ªïng: <span id="total-percent-display-${i}">0</span>% / <span id="total-target-display-${i}">0</span> Tr
                        </div>
                    </div>
                </div>
            `;
        }
        contentHtml += '</div>';
        container.innerHTML = tabsHtml + contentHtml;

        for (let i = 1; i <= count; i++) {
            loadStoreInputs(i);
            ['dataInput6', 'dataInput7'].forEach(type => {
                document.getElementById(`${type}_${i}`).addEventListener('input', () => {
                     setTimeout(() => extractEmployeesFromInputs(i), 500);
                });
            });
            document.getElementById(`input-tab-content-${i}`).addEventListener('click', handlePaste);
            extractEmployeesFromInputs(i);
        }
    }

    function switchInputTab(index) {
        document.querySelectorAll('.input-tab-btn').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.input-tab-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`input-tab-btn-${index}`).classList.add('active');
        document.getElementById(`input-tab-content-${index}`).classList.add('active');
    }

    function loadStoreInputs(index) {
        [`dataInput7_${index}`, `dataInput6_${index}`, `dataInput2_${index}`, `storeTargetInput_${index}`].forEach(id => {
            const saved = localStorage.getItem(id);
            if(saved) document.getElementById(id).value = saved;
        });
    }

    // --- EMPLOYEE EXTRACTION ---
    function extractEmployeesFromInputs(storeIndex) {
        const data6 = document.getElementById(`dataInput6_${storeIndex}`).value;
        const data7 = document.getElementById(`dataInput7_${storeIndex}`).value;
        let employeeSet = new Set();
        
        if (data6.trim()) {
            const lines = data6.split('\n');
            const headers = lines[0].split('\t').map(h => h.trim());
            const nameIndex = headers.findIndex(h => h.includes('Nh√¢n vi√™n'));
            if (nameIndex !== -1) {
                 lines.slice(1).forEach(row => {
                    const cells = row.split('\t');
                    const nameId = (cells[nameIndex] || '').trim();
                    if (nameId && nameId.includes(' - ') && !nameId.startsWith('T·ªîNG') && !nameId.startsWith('BP')) {
                         employeeSet.add(nameId);
                    }
                });
            }
        }
        if (employeeSet.size === 0 && data7.trim()) {
             const lines = data7.split('\n');
             const subHeaderIndex = lines.findIndex(line => line.trim().startsWith('SLLK'));
             if (subHeaderIndex !== -1) {
                 lines.slice(subHeaderIndex + 1).forEach(row => {
                     const cells = row.split('\t');
                     const nameId = (cells[0] || '').trim();
                     if (nameId && nameId.includes(' - ') && !nameId.startsWith('T·ªîNG') && !nameId.startsWith('BP')) {
                        if (!['PH·ª§ KI·ªÜN', 'T·ªîNG C·ªòNG'].includes(nameId.split(' - ')[0].trim().toUpperCase())) {
                             employeeSet.add(nameId);
                        }
                     }
                 });
             }
        }
        if (employeeSet.size > 0) {
            const newEmployeeList = Array.from(employeeSet).sort();
            const currentList = detectedEmployeesMap[storeIndex] || [];
            if (JSON.stringify(newEmployeeList) !== JSON.stringify(currentList.map(e => e.id))) {
                detectedEmployeesMap[storeIndex] = newEmployeeList.map(id => ({ id: id, name: id.split(' - ')[0].trim(), checked: true, percent: 0 }));
                renderEmployeeTargetList(storeIndex);
            }
        }
    }

    function renderEmployeeTargetList(storeIndex) {
        const container = document.getElementById(`employee-target-list-${storeIndex}`);
        const mode = document.querySelector(`input[name="targetMode_${storeIndex}"]:checked`).value;
        const employees = detectedEmployeesMap[storeIndex] || [];

        if (employees.length === 0) {
            container.innerHTML = '<div style="padding: 20px; text-align: center; color: #aaa;">Ch∆∞a c√≥ d·ªØ li·ªáu nh√¢n vi√™n.</div>';
            return;
        }
        
        let html = '';
        employees.forEach((emp, index) => {
            const disabled = mode === 'even' ? 'disabled' : '';
            const bgStyle = mode === 'even' ? 'background-color: #f0f0f0;' : '';
            html += `
                <div class="employee-target-row">
                    <input type="checkbox" ${emp.checked ? 'checked' : ''} onchange="updateEmployeeCheck(${storeIndex}, ${index}, this.checked)">
                    <label class="employee-name-label">${emp.name}</label>
                    <div>
                        <input type="number" value="${emp.percent}" ${disabled} style="${bgStyle}" min="0" max="100" step="0.1" onchange="updateEmployeePercent(${storeIndex}, ${index}, this.value)">
                    </div>
                    <div class="employee-target-val" id="emp-target-val-${storeIndex}-${index}">0</div>
                </div>
            `;
        });
        container.innerHTML = html;
        updateEmployeeTargets(storeIndex);
    }
    
    function updateEmployeeCheck(storeIndex, empIndex, checked) {
        detectedEmployeesMap[storeIndex][empIndex].checked = checked;
        updateEmployeeTargets(storeIndex);
    }
    
    function updateEmployeePercent(storeIndex, empIndex, value) {
        detectedEmployeesMap[storeIndex][empIndex].percent = parseFloat(value) || 0;
        updateEmployeeTargets(storeIndex);
    }
    
    function toggleAllEmployees(storeIndex, checked) {
        if(detectedEmployeesMap[storeIndex]) {
            detectedEmployeesMap[storeIndex].forEach(emp => emp.checked = checked);
            renderEmployeeTargetList(storeIndex);
        }
    }

    function updateEmployeeTargets(storeIndex) {
        const totalTarget = parseFloat(document.getElementById(`storeTargetInput_${storeIndex}`).value.replace(/,/g, '')) || 0;
        const mode = document.querySelector(`input[name="targetMode_${storeIndex}"]:checked`).value;
        const employees = detectedEmployeesMap[storeIndex] || [];
        const activeEmployees = employees.filter(e => e.checked);
        const count = activeEmployees.length;
        
        let totalPercentUsed = 0;
        let totalValueUsed = 0;
        
        if (mode === 'even') {
            const evenValue = count > 0 ? totalTarget / count : 0;
            const evenPercent = totalTarget > 0 ? (evenValue / totalTarget * 100) : 0;
            
            employees.forEach((emp, index) => {
                const valEl = document.getElementById(`emp-target-val-${storeIndex}-${index}`);
                const row = valEl.parentElement;
                const perInput = row.querySelector('input[type="number"]');
                if (valEl) {
                    if (emp.checked) {
                        valEl.textContent = formatNumberFull(evenValue, 0);
                        if(perInput) perInput.value = evenPercent.toFixed(2);
                        totalValueUsed += evenValue;
                        totalPercentUsed += evenPercent;
                    } else {
                        valEl.textContent = '0';
                        if(perInput) perInput.value = '';
                    }
                }
            });
        } else {
             employees.forEach((emp, index) => {
                const valEl = document.getElementById(`emp-target-val-${storeIndex}-${index}`);
                if (valEl) {
                    if (emp.checked) {
                        const val = totalTarget * (emp.percent / 100);
                        valEl.textContent = formatNumberFull(val, 0);
                        totalValueUsed += val;
                        totalPercentUsed += emp.percent;
                    } else {
                        valEl.textContent = '0';
                    }
                }
            });
        }
        
        const sumP = document.getElementById(`total-percent-display-${storeIndex}`);
        const sumT = document.getElementById(`total-target-display-${storeIndex}`);
        if(sumP) sumP.textContent = Math.round(totalPercentUsed);
        if(sumT) sumT.textContent = formatNumberFull(totalValueUsed, 0);
    }

    // --- PROCESSING DATA ---
    function processData(skipHeaderExtraction = false) {
        const storeCount = parseInt(document.getElementById('storeCountSelector').value);
        allStoresData = []; 

        try {
            for (let i = 1; i <= storeCount; i++) {
                const inputs = {
                    data7: document.getElementById(`dataInput7_${i}`).value,
                    data6: document.getElementById(`dataInput6_${i}`).value,
                    data2: document.getElementById(`dataInput2_${i}`).value,
                    storeTarget: parseFloat(document.getElementById(`storeTargetInput_${i}`).value.replace(/,/g, '')) || 0
                };
                
                if (!inputs.data7 || !inputs.data6 || !inputs.data2) {
                    console.warn(`Store ${i} missing data.`);
                    continue; 
                }

                if ((!skipHeaderExtraction || allContestHeadersGlobal.length === 0) && inputs.data7) {
                    const lines7 = inputs.data7.split('\n').filter(line => line.trim());
                    const subHeaderIndex7 = lines7.findIndex(line => line.trim().startsWith('SLLK'));
                    let allHeaders = lines7.slice(1, subHeaderIndex7).map(h => h.trim()).filter(Boolean);
                    
                    // --- UPDATE: B·ªò L·ªåC T√äN NH√ÇN VI√äN ---
                    const invalidHeaderKeywords = [
                        'DTLK', 'SLLK', 'T·ªïng', 'BP All In One', 
                        'Nguy·ªÖn', 'B√πi', 'D∆∞∆°ng', 'ƒê·ªó', 'Tr·∫ßn', 'L√™', 'Ph·∫°m', 'Ho√†ng', 'Phan', 'V≈©', 'ƒê·∫∑ng', 'Th·ªã', 
                        'Ng√¥', 'Tr∆∞∆°ng', 'L∆∞∆°ng', 'Th√°i', 'V∆∞∆°ng', 'ƒêinh', 'L√Ω', 'H·ªì', 'Cao', 'Tr·ªãnh' 
                    ];
                    
                    const extractedHeaders = allHeaders.filter(header => {
                        if (invalidHeaderKeywords.some(keyword => header.includes(keyword))) return false;
                        if (/\s-\s\d+/.test(header)) return false; 
                        return true;
                    });
                    
                    extractedHeaders.forEach(h => {
                         if(!allContestHeadersGlobal.includes(h)) allContestHeadersGlobal.push(h);
                    });
                }
            }
            
            if (selectedContestHeaders.length === 0 && allContestHeadersGlobal.length > 0) {
                 selectedContestHeaders = [...allContestHeadersGlobal];
                 localStorage.setItem('selectedContestHeaders', JSON.stringify(selectedContestHeaders));
            }

            let finalContestHeaders;
            if (document.getElementById('allContestsCheckbox').checked) {
                finalContestHeaders = [...allContestHeadersGlobal];
            } else {
                finalContestHeaders = allContestHeadersGlobal.filter(header => selectedContestHeaders.includes(header));
            }
            
            if (finalContestHeaders.length === 0 && allContestHeadersGlobal.length > 0) {
                showToast("Vui l√≤ng ch·ªçn ng√†nh h√†ng.");
                return;
            }

            for (let i = 1; i <= storeCount; i++) {
                const processedStore = processSingleStore(i, finalContestHeaders);
                if (processedStore) {
                    allStoresData.push(processedStore);
                    localStorage.setItem(`dataInput7_${i}`, document.getElementById(`dataInput7_${i}`).value);
                    localStorage.setItem(`dataInput6_${i}`, document.getElementById(`dataInput6_${i}`).value);
                    localStorage.setItem(`dataInput2_${i}`, document.getElementById(`dataInput2_${i}`).value);
                    localStorage.setItem(`storeTargetInput_${i}`, document.getElementById(`storeTargetInput_${i}`).value);
                }
            }
            
            if (allStoresData.length === 0) {
                 showToast("Vui l√≤ng nh·∫≠p d·ªØ li·ªáu cho √≠t nh·∫•t 1 si√™u th·ªã.");
                 return;
            }

            renderTabs(allStoresData);
            switchStoreTab(0); 

            document.getElementById('data-input-card').style.display = 'none';
            document.getElementById('report-header').style.display = 'flex';
            document.getElementById('report-tabs-container').style.display = 'flex';
            document.getElementById('results-wrapper').style.display = 'block';
            
            updateContestStatusUI();

        } catch (error) {
            console.error(error);
            showToast(`L·ªói x·ª≠ l√Ω: ${error.message}`);
        }
    }

    function processSingleStore(index, headers) {
         const d7 = document.getElementById(`dataInput7_${index}`).value;
         const d6 = document.getElementById(`dataInput6_${index}`).value;
         const d2 = document.getElementById(`dataInput2_${index}`).value;
         const storeTarget = parseFloat(document.getElementById(`storeTargetInput_${index}`).value.replace(/,/g, '')) || 0;
         if (!d7 || !d6 || !d2) return null;

         const lines7 = d7.split('\n').filter(line => line.trim());
         const subHeaderIndex7 = lines7.findIndex(line => line.trim().startsWith('SLLK'));
         const fullHeaders = lines7.slice(1, subHeaderIndex7).map(h => h.trim()).filter(Boolean);
         const fullHeaderMap = fullHeaders.reduce((map, header, idx) => { map[header] = idx; return map; }, {});
         
         const employeeMap = new Map();
         lines7.slice(subHeaderIndex7 + 1).forEach(row => {
             const cells = row.split('\t');
             const nameId = (cells[0] || '').trim();
             if (nameId.includes(' - ')) {
                 const nameOnly = nameId.split(' - ')[0].trim();
                 if (!['PH·ª§ KI·ªÜN', 'T·ªîNG', 'T·ªîNG C·ªòNG'].includes(nameOnly.toUpperCase())) {
                     const sales = {};
                     headers.forEach(h => {
                         const idx = fullHeaderMap[h];
                         sales[h] = parseFloat(String(cells[idx + 1] || '0').replace(/,/g, '')) || 0;
                     });
                     employeeMap.set(nameId, { name: nameOnly, id: nameId, sales });
                 }
             }
         });

         const contestTargetsStore = {};
         const contestStoreStats = {};
         const lines2 = d2.split('\n').filter(l => l.trim());
         if (lines2.length > 1) {
             const h2 = lines2.shift().split('\t').map(h => h.trim());
             const nIdx = h2.findIndex(h => h.includes('Ng√†nh h√†ng'));
             const dtqdIdx = h2.findIndex(h => h === 'DTQƒê');
             const tIdx = h2.findIndex(h => h === 'Target');
             const pIdx = h2.findIndex(h => h.includes('% HT D·ª± Ki·∫øn'));
             
             if (nIdx !== -1) {
                 lines2.forEach(row => {
                     const cells = row.split('\t');
                     const cat = (cells[nIdx] || '').trim();
                     if (headers.includes(cat)) {
                         contestTargetsStore[cat] = parseFloat(cells[tIdx].replace(/,/g, '')) || 0;
                         contestStoreStats[cat] = {
                             actual: parseFloat(cells[dtqdIdx].replace(/,/g, '')) || 0,
                             projectedPercentFromSource: parseFloat(String(cells[pIdx]).replace(/%/g, '')) || 0
                         };
                     }
                 });
             }
         }

         const activeEmployees = (detectedEmployeesMap[index] || []).filter(e => e.checked);
         const targetMap = new Map();
         const percentMap = new Map();
         const count = activeEmployees.length;
         const mode = document.querySelector(`input[name="targetMode_${index}"]:checked`).value;
         const evenValue = count > 0 ? storeTarget / count : 0;
         
         (detectedEmployeesMap[index] || []).forEach(emp => {
             if (emp.checked) {
                 if (mode === 'even') {
                     targetMap.set(emp.id, evenValue);
                     percentMap.set(emp.id, count > 0 ? (100/count) : 0);
                 } else {
                     targetMap.set(emp.id, storeTarget * (emp.percent / 100));
                     percentMap.set(emp.id, emp.percent);
                 }
             } else {
                 targetMap.set(emp.id, 0);
                 percentMap.set(emp.id, 0);
             }
         });

         const lines6 = d6.split('\n').filter(l => l.trim());
         if (lines6.length > 1) {
             const h6 = lines6.shift().split('\t').map(h => h.trim());
             const nIdx6 = h6.findIndex(h => h.includes('vi√™n'));
             const dtqdIdx6 = h6.findIndex(h => h === 'DTQƒê');
             employeeMap.forEach((emp, nameId) => {
                 const row6 = lines6.find(r => (r.split('\t')[nIdx6] || '').trim() === nameId);
                 emp.actual_DTQD = row6 ? parseFloat((row6.split('\t')[dtqdIdx6] || '0').replace(/,/g, '')) || 0 : 0;
             });
         }

         const currentMonthTimeframe = getContestTimeframe('');
         const storeData = [];
         
         employeeMap.forEach(employee => {
             employee.revenueTarget = targetMap.get(employee.id) || 0;
             const empPercent = percentMap.get(employee.id) || 0;
             employee.contestTargets = {};
             
             headers.forEach(h => {
                 if(contestTargetsStore[h]) {
                     employee.contestTargets[h] = Math.ceil(contestTargetsStore[h] * (empPercent / 100));
                 }
             });

             employee.revenueCompletion = employee.revenueTarget > 0 ? (employee.actual_DTQD / employee.revenueTarget) * 100 : 0;
             employee.projectedRevenueCompletion = employee.revenueTarget > 0 ? (employee.actual_DTQD / currentMonthTimeframe.passedDays * currentMonthTimeframe.totalDays) / employee.revenueTarget * 100 : 0;
             
             employee.contestCompletion = {};
             employee.projectedCompletedContests = 0;
             
             headers.forEach(key => {
                 const tf = getContestTimeframe(key);
                 const target = employee.contestTargets[key] || 0;
                 const actual = employee.sales[key] || 0;
                 const projectedPercent = target > 0 ? (actual / tf.passedDays * tf.totalDays) / target * 100 : 0;
                 employee.contestCompletion[key] = { 
                     target, actual, 
                     percent: target > 0 ? (actual/target)*100 : 0, 
                     projectedPercent 
                 };
                 if (projectedPercent >= 100) employee.projectedCompletedContests++;
             });
             
             employee.overallProjectedContestCompletion = headers.length > 0 ? (employee.projectedCompletedContests / headers.length) * 100 : 0;
             employee.totalScore = employee.projectedRevenueCompletion + employee.overallProjectedContestCompletion;

             if (activeEmployees.some(e => e.id === employee.id)) {
                 storeData.push(employee);
             }
         });

         storeData.sort((a,b) => b.totalScore - a.totalScore);
         storeData.forEach((e, idx) => e.rank = idx + 1);

         const contestProjectedTotals = {};
         headers.forEach(h => {
             contestProjectedTotals[h] = contestStoreStats[h] ? contestStoreStats[h].projectedPercentFromSource : 0;
         });
         
         return {
             index: index,
             name: `Si√™u th·ªã ${index}`,
             data: storeData,
             headers: [...headers].sort((a, b) => (contestProjectedTotals[b] || 0) - (contestProjectedTotals[a] || 0)),
             projectedTotals: contestProjectedTotals,
             timeframe: currentMonthTimeframe
         };
    }
    
    // --- UI RENDERING & TABS ---
    function renderTabs(stores) {
        const container = document.getElementById('report-tabs-container');
        let html = '';
        stores.forEach((store, idx) => {
            html += `<button class="report-tab-btn ${idx === 0 ? 'active' : ''}" onclick="switchStoreTab(${idx})">${store.name}</button>`;
        });
        container.innerHTML = html;
    }

    function switchStoreTab(arrayIndex) {
        if (!allStoresData[arrayIndex]) return;
        const tabs = document.querySelectorAll('.report-tab-btn');
        tabs.forEach((t, i) => {
            if (i === arrayIndex) t.classList.add('active');
            else t.classList.remove('active');
        });

        const storeObj = allStoresData[arrayIndex];
        finalData = storeObj.data; 
        currentStoreIndex = storeObj.index;
        sortedContestHeadersGlobal = storeObj.headers;
        
        comparisonResultsCache = null;
        document.getElementById('toggleComparisonBtn').style.display = 'none';

        const today = new Date();
        document.getElementById('reportTitle').textContent = `B√°o c√°o ƒë√°nh gi√° ${storeObj.name} ƒë·∫øn ng√†y ${today.toLocaleDateString('vi-VN')}`;
        
        renderMonthProgress(storeObj.timeframe);
        renderComprehensiveDashboard(finalData, sortedContestHeadersGlobal, storeObj.projectedTotals);
        renderStramAnalysis(finalData);
        renderAllEmployeeCards(finalData);
        renderCommentsBox(finalData);
        
        detectedEmployees = detectedEmployeesMap[currentStoreIndex] || [];
    }

    function renderMonthProgress(timeframe) {
        document.getElementById('month-progress-container').innerHTML = `
            <div class="progress-bar-wrapper" style="margin-top:0;">
                <div class="progress-bar-label"><span>Ti·∫øn ƒë·ªô Th√°ng</span><span>${(timeframe.passedDays / timeframe.totalDays * 100).toFixed(1)}%</span></div>
                <div class="progress-bar-bg" style="height:12px;"><div class="progress-bar-fill" style="width: ${(timeframe.passedDays / timeframe.totalDays * 100)}%;"></div></div>
            </div>`;
        document.getElementById('month-progress-container').style.display = 'block';
    }

    // --- IMPORT/EXPORT ALL ---
    function exportAllData() {
        const storeCount = document.getElementById('storeCountSelector').value;
        const allInputs = { storeCount: storeCount, stores: {} };
        for(let i=1; i<=storeCount; i++) {
            allInputs.stores[i] = {
                d2: document.getElementById(`dataInput2_${i}`).value,
                d6: document.getElementById(`dataInput6_${i}`).value,
                d7: document.getElementById(`dataInput7_${i}`).value,
                target: document.getElementById(`storeTargetInput_${i}`).value,
                empMode: document.querySelector(`input[name="targetMode_${i}"]:checked`).value,
                employees: detectedEmployeesMap[i] || []
            };
        }
        document.getElementById('allDataImportExportData').value = JSON.stringify(allInputs);
        try { document.getElementById('allDataImportExportData').select(); document.execCommand('copy'); showToast('ƒê√£ sao ch√©p to√†n b·ªô d·ªØ li·ªáu!'); } catch (err) { showToast('Copy th·ªß c√¥ng.'); }
    }

    function importAllData() {
        try {
            const data = JSON.parse(document.getElementById('allDataImportExportData').value);
            if(data.storeCount) {
                document.getElementById('storeCountSelector').value = data.storeCount;
                renderStoreInputs(data.storeCount); 
                for(let i=1; i<=data.storeCount; i++) {
                    const storeData = data.stores[i];
                    if(storeData) {
                        document.getElementById(`dataInput2_${i}`).value = storeData.d2 || '';
                        document.getElementById(`dataInput6_${i}`).value = storeData.d6 || '';
                        document.getElementById(`dataInput7_${i}`).value = storeData.d7 || '';
                        document.getElementById(`storeTargetInput_${i}`).value = storeData.target || '';
                        const radios = document.querySelectorAll(`input[name="targetMode_${i}"]`);
                        radios.forEach(r => r.checked = (r.value === storeData.empMode));
                        detectedEmployeesMap[i] = storeData.employees || [];
                        renderEmployeeTargetList(i);
                    }
                }
                showToast('ƒê√£ kh√¥i ph·ª•c d·ªØ li·ªáu th√†nh c√¥ng!');
            }
        } catch(e) { showToast('L·ªói nh·∫≠p d·ªØ li·ªáu.'); console.error(e); }
    }
    
    function saveStoreDaily(index) {
        const storeData = allStoresData.find(s => s.index === index);
        if(storeData) saveDailyPerformance(storeData.data, index);
        else showToast("Vui l√≤ng x·ª≠ l√Ω d·ªØ li·ªáu tr∆∞·ªõc khi l∆∞u.");
    }
    
    function saveDailyPerformance(data, storeIndex) {
        const key = `performanceHistory_ST${storeIndex}`;
        const today = getTodayDateString();
        const simplified = data.map(e => ({
            id: e.id, name: e.name, rank: e.rank, totalScore: e.totalScore,
            projectedRevenueCompletion: e.projectedRevenueCompletion,
            overallProjectedContestCompletion: e.overallProjectedContestCompletion,
            contestCompletion: Object.fromEntries(Object.entries(e.contestCompletion).map(([k,v]) => [k, {actual: Math.round(v.actual), projectedPercent: v.projectedPercent}]))
        }));
        let history = JSON.parse(localStorage.getItem(key) || '{}');
        history[today] = simplified;
        localStorage.setItem(key, JSON.stringify(history));
        showToast(`ƒê√£ l∆∞u l·ªãch s·ª≠ cho Si√™u th·ªã ${storeIndex} ng√†y ${today}`);
    }

    // --- REUSED FUNCTIONS ---
    function showToast(message) {
        const toast = document.getElementById('toast-notification');
        toast.textContent = message;
        toast.classList.add('show');
        setTimeout(() => { toast.classList.remove('show'); }, 3000);
    }
    function formatNumberFull(num, decimals = 0) {
        if (isNaN(num) || num === null) return '0';
        return num.toLocaleString('vi-VN', { minimumFractionDigits: decimals, maximumFractionDigits: decimals });
    }
    function getInitials(name) {
        if (!name) return '';
        const parts = name.trim().split(' ').filter(p => p);
        if (parts.length >= 2) return `${parts[0].charAt(0)}${parts[parts.length - 1].charAt(0)}`.toUpperCase();
        if (parts.length === 1) return parts[0].substring(0, 2).toUpperCase();
        return '';
    }
    function abbreviateName(name) {
        if (!name) return '';
        const parts = name.trim().split(' ').filter(p => p);
        if (parts.length <= 1) return name;
        const lastName = parts.pop();
        const initials = parts.map(p => p.charAt(0).toUpperCase()).join('.');
        return `${initials}.${lastName}`;
    }
    function formatDate(date) {
        const d = new Date(date);
        let month = '' + (d.getMonth() + 1), day = '' + d.getDate(), year = d.getFullYear();
        if (month.length < 2) month = '0' + month;
        if (day.length < 2) day = '0' + day;
        return [year, month, day].join('-');
    }
    function getTodayDateString() { return formatDate(new Date()); }
    
    function getContestTimeframe(header) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const currentYear = today.getFullYear();
        const totalDays = new Date(currentYear, today.getMonth() + 1, 0).getDate();
        const passedDays = today.getDate() - 1; 
        const remainingDays = totalDays - passedDays;
        const defaultTf = { passedDays: Math.max(1, passedDays), totalDays, remainingDays: Math.max(1, remainingDays) };
        const match = header.match(/\(\s*T(\d+)\s*-\s*T(\d+)\s*\)/);
        if (match) {
            try {
                const sM = parseInt(match[1], 10) - 1;
                const eM = parseInt(match[2], 10) - 1;
                const sD = new Date(currentYear, sM, 1);
                const eD = new Date(currentYear, eM + 1, 0);
                if (sD > eD) return defaultTf;
                let tDays = 0;
                for (let m = sM; m <= eM; m++) tDays += new Date(currentYear, m + 1, 0).getDate();
                const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1); yesterday.setHours(0,0,0,0);
                let pDays = 0;
                if (yesterday >= sD) pDays = yesterday > eD ? tDays : Math.floor((yesterday - sD) / 86400000) + 1;
                const cDay = Math.min(Math.floor((today - sD) / 86400000) + 1, tDays);
                return { passedDays: Math.max(1, pDays), totalDays: tDays, remainingDays: Math.max(1, tDays - cDay + 1) };
            } catch (e) { return defaultTf; }
        }
        return defaultTf;
    }

    function updateContestStatusUI() {
        const total = allContestHeadersGlobal.length;
        const selected = selectedContestHeaders.length;
        const allCheckbox = document.getElementById('allContestsCheckbox');
        if (allCheckbox && document.getElementById('contestCountStatus')) {
             document.getElementById('contestCountStatus').textContent = allCheckbox.checked ? `(${total}/${total} nh√≥m)` : `(${selected}/${total} nh√≥m)`;
        }
    }

    async function handlePaste(event) {
        if (!event.target.classList.contains('btn-paste')) return;
        const targetId = event.target.dataset.target;
        const filterType = event.target.dataset.filter;
        const textarea = document.getElementById(targetId);
        try {
            const text = await navigator.clipboard.readText();
            const markers = { table2: /^Ng√†nh h√†ng\s+DTQƒê/, table6: /^Nh√¢n vi√™n\s+DTLK/, table7: /^Ph√≤ng ban/ };
            const lines = text.split('\n');
            const startIndex = lines.findIndex(line => markers[filterType] && markers[filterType].test(line.trim()));
            if (startIndex !== -1) {
                let endIndex = lines.findIndex(line => line.includes("H·ªó tr·ª£ BI"), startIndex);
                if (endIndex === -1) endIndex = lines.length;
                textarea.value = lines.slice(startIndex, endIndex).join('\n').trim();
            } else {
                textarea.value = text;
            }
            showToast(`ƒê√£ d√°n d·ªØ li·ªáu v√†o ${targetId}`);
            const storeIdx = targetId.split('_')[1];
            if(storeIdx) setTimeout(() => extractEmployeesFromInputs(parseInt(storeIdx)), 200);
        } catch (e) { showToast('L·ªói d√°n clipboard'); }
    }

    function showInputCard() {
        document.getElementById('results-wrapper').style.display = 'none';
        document.getElementById('report-header').style.display = 'none';
        document.getElementById('report-tabs-container').style.display = 'none';
        document.getElementById('data-input-card').style.display = 'block';
    }

    function captureFullTable() {
        const container = document.getElementById('comprehensiveLeaderboardContainer');
        const card = container.closest('.card');
        const originalStyles = { overflowX: container.style.overflowX, maxHeight: container.style.maxHeight, width: card.style.width, maxWidth: card.style.maxWidth };
        container.style.overflowX = 'visible'; container.style.maxHeight = 'none';
        card.style.width = 'fit-content'; card.style.maxWidth = 'none';
        document.body.style.overflow = 'hidden';
        showToast('ƒêang ch·ª•p ·∫£nh...');
        setTimeout(() => {
            html2canvas(card, { scale: 2, useCORS: true, backgroundColor: '#F4F7F9' }).then(canvas => {
                const link = document.createElement('a');
                link.download = `BangTongHop_ST${currentStoreIndex}.png`;
                link.href = canvas.toDataURL('image/png');
                link.click();
                showToast("ƒê√£ ch·ª•p xong!");
            }).finally(() => {
                container.style.overflowX = originalStyles.overflowX; container.style.maxHeight = originalStyles.maxHeight;
                card.style.width = originalStyles.width; card.style.maxWidth = originalStyles.maxWidth;
                document.body.style.overflow = '';
            });
        }, 500);
    }
    
    function captureAllIndividualCards() {
        const cards = document.querySelectorAll('#allCardsContainer .perf-card');
        if (cards.length === 0) return showToast("Kh√¥ng c√≥ th·∫ª KPI.");
        showToast(`B·∫Øt ƒë·∫ßu ch·ª•p ${cards.length} th·∫ª...`);
        cards.forEach((card, index) => {
            const name = card.querySelector('.name-block h2').textContent.trim();
            setTimeout(() => captureAndDownload(card, `KPI_ST${currentStoreIndex}_${name}.png`), index * 800);
        });
    }

    function captureAndDownload(element, filename) {
        const reportTitleEl = document.getElementById('reportTitle');
        if(reportTitleEl) reportTitleEl.style.display = 'block'; 
        html2canvas(element, { useCORS: true, scale: 2, backgroundColor: '#F4F7F9' }).then(canvas => {
            const link = document.createElement('a');
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            link.click();
        }).finally(() => { if(reportTitleEl) reportTitleEl.style.display = 'none'; });
    }

    function copyComments() {
        const textarea = document.getElementById('comments-textarea');
        textarea.select();
        document.execCommand('copy');
        showToast('ƒê√£ sao ch√©p nh·∫≠n x√©t!');
    }

    function runComparison() {
        const start = document.getElementById('comparisonStartDate').value;
        const end = document.getElementById('comparisonEndDate').value;
        if (!start || !end || start > end) return showToast('Vui l√≤ng ki·ªÉm tra ng√†y so s√°nh.');
        
        const historyKey = `performanceHistory_ST${currentStoreIndex}`;
        const history = JSON.parse(localStorage.getItem(historyKey) || '{}');
        let endData = (end === getTodayDateString()) ? 
            finalData.map(e => ({
                id: e.id, totalScore: e.totalScore, projectedRevenueCompletion: e.projectedRevenueCompletion, overallProjectedContestCompletion: e.overallProjectedContestCompletion,
                contestCompletion: Object.fromEntries(Object.entries(e.contestCompletion).map(([k,v]) => [k, {actual: Math.round(v.actual), projectedPercent: v.projectedPercent}]))
            })) : history[end];
        let startData = (start === end) ? endData : history[start];
        if (!startData || !endData) return showToast(`Thi·∫øu d·ªØ li·ªáu l·ªãch s·ª≠ cho ST ${currentStoreIndex}.`);
        
        const startMap = new Map(startData.map(e => [e.id, e]));
        comparisonResultsCache = endData.map(endEmp => {
            const startEmp = startMap.get(endEmp.id);
            if (!startEmp) return { ...endEmp, changeScore: 'N/A' };
            const contestChanges = Object.keys(endEmp.contestCompletion || {}).map(k => ({
                name: k,
                changeActual: (endEmp.contestCompletion[k]?.actual || 0) - (startEmp.contestCompletion?.[k]?.actual || 0),
                changeProjectedPercent: (endEmp.contestCompletion[k]?.projectedPercent || 0) - (startEmp.contestCompletion?.[k]?.projectedPercent || 0)
            }));
            return {
                id: endEmp.id,
                changeScore: endEmp.totalScore - startEmp.totalScore,
                changeRevenue: endEmp.projectedRevenueCompletion - startEmp.projectedRevenueCompletion,
                changeContest: endEmp.overallProjectedContestCompletion - startEmp.overallProjectedContestCompletion,
                contestChanges
            };
        });
        renderAllEmployeeCards(finalData);
        renderComprehensiveDashboard(finalData, sortedContestHeadersGlobal, allStoresData[currentStoreIndex-1].projectedTotals); 
        document.getElementById('toggleComparisonBtn').style.display = 'inline-block';
        showToast('ƒê√£ so s√°nh xong.');
    }

    function toggleComparisonDisplay() {
        comparisonResultsCache = null;
        document.getElementById('toggleComparisonBtn').style.display = 'none';
        renderAllEmployeeCards(finalData);
        renderComprehensiveDashboard(finalData, sortedContestHeadersGlobal, allStoresData[currentStoreIndex-1].projectedTotals);
    }
    
    function getComparisonData(id) {
        return comparisonResultsCache ? comparisonResultsCache.find(r => r.id === id) : null;
    }
    
    function getChangeHtml(value, decimals = 1, isPercent = false) {
        if (value === 'N/A') return '';
        const num = parseFloat(value);
        if (isNaN(num) || Math.abs(num) < (isPercent ? 0.001 : 1)) return '';
        const icon = num > 0 ? '‚ñ≤' : '‚ñº';
        const cls = num > 0 ? 'change-up' : 'change-down';
        const display = isPercent ? Math.abs(num).toFixed(decimals) + '%' : formatNumberFull(Math.round(Math.abs(num)), 0);
        return `<span class="comparison-change ${cls}">${icon} ${display}</span>`;
    }

    function renderComprehensiveDashboard(data, headers, projectedTotals) {
        const container = document.getElementById('comprehensiveLeaderboardContainer');
        let html = `<table class="comprehensive-table"><thead><tr><th>H·∫°ng</th><th>Nh√¢n vi√™n</th><th>ƒêi·ªÉm</th><th>S·ªë ng√†nh HT</th><th>Ti·∫øn ƒë·ªô DT</th>`;
        headers.forEach((h, i) => {
            const total = projectedTotals[h] || 0;
            html += `<th class="contest-header-cell"><div class="clickable-header" onclick="showContestDetailsPopup('${encodeURIComponent(h)}', event)">${i+1}. ${h}</div><div style="color:${total>=100?'var(--success-color)':'var(--danger-color)'}">${total.toFixed(1)}%</div></th>`;
        });
        html += `</tr></thead><tbody>`;
        data.forEach(e => {
            const comp = getComparisonData(e.id);
            const scoreDisplay = comp ? `${e.totalScore.toFixed(1)} ${getChangeHtml(comp.changeScore, 1)}` : e.totalScore.toFixed(1);
            let rankIcon = e.rank === 1 ? 'ü•á' : (e.rank === 2 ? 'ü•à' : (e.rank === 3 ? 'ü•â' : (e.rank >= data.length - 2 && data.length > 3 ? 'üî¥' : e.rank)));
            html += `<tr><td class="rank-cell">${rankIcon}</td>
                <td><a href="#" class="clickable-name" onclick="showEmployeeDetailsPopup('${e.id}', event)">${abbreviateName(e.name)}</a></td>
                <td style="font-weight:700">${scoreDisplay}</td>
                <td style="font-weight:700">${e.projectedCompletedContests}/${headers.length}</td>
                <td><div class="progress-bar-wrapper"><div class="progress-bar-label"><span>${e.revenueCompletion.toFixed(1)}%</span></div><div class="progress-bar-bg"><div class="progress-bar-fill ${e.revenueCompletion>=100?'success':''}" style="width:${Math.min(100,e.revenueCompletion)}%"></div></div></div></td>`;
            headers.forEach(h => {
                const item = e.contestCompletion[h] || {actual: 0, target: 0, projectedPercent: 0};
                const actualDisplay = formatNumberFull(item.actual, 0); 
                const targetDisplay = formatNumberFull(item.target, 0);
                html += `<td class="heatmap-cell">
                    <span class="percent-badge ${item.projectedPercent>=100?'badge-green':'badge-red'}">${item.projectedPercent.toFixed(1)}%</span>
                    <div class="sub-target-display">${actualDisplay} / ${targetDisplay}</div>
                </td>`;
            });
            html += `</tr>`;
        });
        container.innerHTML = html + '</tbody></table>';
    }

    function renderAllEmployeeCards(data) {
        document.getElementById('allCardsContainer').innerHTML = data.map(e => getEmployeeCardHtml(e, data.length, getComparisonData(e.id))).join('');
    }

    function getEmployeeCardHtml(employee, total, comp) {
        const revRem = employee.revenueTarget - employee.actual_DTQD;
        const tf = getContestTimeframe('');
        const todayTarget = (revRem > 0 && tf.remainingDays > 0) ? revRem / tf.remainingDays : 0;
        const isDone = employee.actual_DTQD >= employee.revenueTarget;
        const avatar = `<svg width="60" height="60"><circle cx="30" cy="30" r="27" fill="#ccc"/><text x="50%" y="50%" dy=".1em" text-anchor="middle" font-size="24" fill="#fff" font-weight="bold">${getInitials(employee.name)}</text></svg>`;
        const rows = sortedContestHeadersGlobal.map((h, i) => {
            const d = employee.contestCompletion[h] || {actual:0, target:0, percent:0, projectedPercent:0};
            const cTf = getContestTimeframe(h);
            const rem = d.target - d.actual;
            const tDay = (rem > 0 && cTf.remainingDays > 0) ? rem / cTf.remainingDays : 0;
            const done = d.actual >= d.target;
            let changeHtml = '';
            if(comp) {
                const c = comp.contestChanges.find(x => x.name === h);
                if(c) changeHtml = getChangeHtml(c.changeActual, 0, false);
            }
            return `<tr>
                <td>${i+1}</td><td>${h}</td>
                ${done ? '<td class="icon-cell">üèÜ</td>' : `<td>${formatNumberFull(tDay, 0)}</td>`}
                <td>${formatNumberFull(d.target,0)}</td>
                <td class="kpi-actual"><span style="display:flex;justify-content:center;gap:5px">${formatNumberFull(d.actual,0)} ${changeHtml}</span></td>
                ${done ? '<td class="icon-cell">üèÜ</td>' : `<td>${formatNumberFull(rem, 0)}</td>`}
                <td class="${getPercentColorClass(d.percent)}">${d.percent.toFixed(0)}%</td>
                <td class="${getPercentColorClass(d.projectedPercent)}">${d.projectedPercent.toFixed(1)}%</td>
            </tr>`;
        }).join('');
        return `<div class="perf-card">
            <div class="perf-header">
                <div class="perf-avatar">${avatar}</div>
                <div class="name-block"><h2>${abbreviateName(employee.name)}</h2><p class="perf-quote">${getMotivationalQuote(employee.rank, total)}</p></div>
                <div class="rank-block"><h3>H·∫†NG ${employee.rank}</h3><p style="font-size:13px">ƒêi·ªÉm: ${employee.totalScore.toFixed(1)} ${comp?getChangeHtml(comp.changeScore,1):''}</p></div>
            </div>
            <div class="perf-body">
                <div class="progress-bar-wrapper" style="margin-top:15px">
                    <div class="progress-bar-label"><span>Ti·∫øn ƒë·ªô Doanh thu ${comp?getChangeHtml(comp.changeRevenue,1,true):''}</span><span>${formatNumberFull(employee.actual_DTQD,0)}/${formatNumberFull(employee.revenueTarget,0)}</span></div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill ${isDone?'success':''}" style="width:${Math.min(100,employee.revenueCompletion)}%"></div></div>
                </div>
                <div class="progress-bar-wrapper">
                    <div class="progress-bar-label"><span>Ti·∫øn ƒë·ªô Thi ƒëua ${comp?getChangeHtml(comp.changeContest,1,true):''}</span><span>${employee.projectedCompletedContests}/${sortedContestHeadersGlobal.length} Nh√≥m</span></div>
                    <div class="progress-bar-bg"><div class="progress-bar-fill ${employee.overallProjectedContestCompletion>=100?'success':''}" style="width:${Math.min(100,employee.overallProjectedContestCompletion)}%"></div></div>
                </div>
                <div class="progress-bar-group">
                    <div><div class="label">Target</div><span class="value">${formatNumberFull(employee.revenueTarget,0)}</span></div>
                    <div><div class="label">L≈©y k·∫ø</div><span class="value">${formatNumberFull(employee.actual_DTQD,0)}</span></div>
                    <div><div class="label">C√≤n l·∫°i</div>${isDone?'<span class="value success-text">üèÜ</span>':`<span class="value">${formatNumberFull(revRem,0)}</span>`}</div>
                    <div><div class="label">D·ª± ki·∫øn</div><span class="value">${employee.projectedRevenueCompletion.toFixed(0)}%</span></div>
                    <div><div class="label">M.Ti√™u Ng√†y</div><span class="value">${isDone?'üèÜ':formatNumberFull(todayTarget,0)}</span></div>
                </div>
                <div class="contest-table-container" style="margin-top:15px">
                    <table class="contest-table"><thead><tr><th>#</th><th>Ng√†nh h√†ng</th><th>M.ti√™u</th><th>Target</th><th>L≈©y k·∫ø</th><th>C√≤n</th><th>%HT</th><th>%DK</th></tr></thead><tbody>${rows}</tbody></table>
                </div>
            </div>
        </div>`;
    }

    function renderCommentsBox(data) {
        if (!data) return;
        const totalDisp = sortedContestHeadersGlobal.length;
        document.getElementById('comments-textarea').value = data.map(e => {
            const icon = e.rank === 1 ? 'ü•á' : (e.rank === 2 ? 'ü•à' : (e.rank === 3 ? 'ü•â' : ''));
            return `${icon}Top ${e.rank} - ${abbreviateName(e.name)}: ‚≠ê ${e.totalScore.toFixed(1)}ƒë | üí∞ DT: ${formatNumberFull(e.actual_DTQD, 0)} | ‚úÖ HT ${e.projectedCompletedContests}/${totalDisp} nh√≥m.`;
        }).join('\n');
    }

    function getPercentColorClass(p) { return p>=100?'text-success':(p>=80?'text-warning':'text-danger'); }
    function getMotivationalQuote(r, t) { return r===1?"D·∫´n ƒë·∫ßu cu·ªôc ƒëua!":r<=3?"Gi·ªØ v·ªØng phong ƒë·ªô!":r<=Math.ceil(t*0.6)?"C·ªë g·∫Øng b·ª©t ph√°!":"N·ªó l·ª±c c·∫£i thi·ªán!"; }
    
    // --- STRAM ANALYSIS FUNCTIONS (UPDATED) ---
    function getOverallDevelopmentLevel(revenuePercent, contestPercent) {
        const highNangLuc = revenuePercent >= 95;
        const highCamKet = contestPercent >= 80;

        if (highNangLuc && highCamKet) {
            return { dLevel: 'D4', sLevel: 'S4', description: 'NƒÉng l·ª±c cao, Cam k·∫øt cao. (Ng∆∞·ªùi t·ª± l·ª±c, ƒë·∫°t th√†nh t·ª±u)', nangLuc: `Cao (${revenuePercent.toFixed(1)}%)`, camKet: `Cao (${contestPercent.toFixed(1)}%)`, revenuePercent: revenuePercent, overallProjectedContestCompletion: contestPercent };
        } else if (highNangLuc && !highCamKet) {
            return { dLevel: 'D3', sLevel: 'S3', description: 'NƒÉng l·ª±c cao, Cam k·∫øt thay ƒë·ªïi. (C√≥ kh·∫£ nƒÉng, nh∆∞ng th·∫≠n tr·ªçng)', nangLuc: `Cao (${revenuePercent.toFixed(1)}%)`, camKet: `Th·∫•p (${contestPercent.toFixed(1)}%)`, revenuePercent: revenuePercent, overallProjectedContestCompletion: contestPercent };
        } else if (!highNangLuc && highCamKet) {
            return { dLevel: 'D1', sLevel: 'S1', description: 'NƒÉng l·ª±c th·∫•p, Cam k·∫øt cao. (Ng∆∞·ªùi m·ªõi, nhi·ªát t√¨nh)', nangLuc: `Th·∫•p (${revenuePercent.toFixed(1)}%)`, camKet: `Cao (${contestPercent.toFixed(1)}%)`, revenuePercent: revenuePercent, overallProjectedContestCompletion: contestPercent };
        } else {
            return { dLevel: 'D2', sLevel: 'S2', description: 'NƒÉng l·ª±c th·∫•p, Cam k·∫øt th·∫•p. (Ng∆∞·ªùi h·ªçc, v·ª° m·ªông)', nangLuc: `Th·∫•p (${revenuePercent.toFixed(1)}%)`, camKet: `Th·∫•p (${contestPercent.toFixed(1)}%)`, revenuePercent: revenuePercent, overallProjectedContestCompletion: contestPercent };
        }
    }

    function getTaskDevelopmentLevel(projectedPercent) {
        if (projectedPercent >= 100) {
            return { dLevel: 'D4', sLevel: 'S4', description: 'T·ª± l·ª±c ƒë·∫°t th√†nh t·ª±u. (NƒÉng l·ª±c cao, Cam k·∫øt cao)' };
        } else if (projectedPercent >= 80) {
            return { dLevel: 'D3', sLevel: 'S3', description: 'C√≥ kh·∫£ nƒÉng nh∆∞ng th·∫≠n tr·ªçng. (NƒÉng l·ª±c cao, Cam k·∫øt thay ƒë·ªïi)' };
        } else if (projectedPercent >= 50) {
            return { dLevel: 'D1', sLevel: 'S1', description: 'Nhi·ªát t√¨nh, c·∫ßn ch·ªâ d·∫´n. (NƒÉng l·ª±c th·∫•p, Cam k·∫øt cao)' };
        } else {
            return { dLevel: 'D2', sLevel: 'S2', description: 'V·ª° m·ªông, c·∫ßn hu·∫•n luy·ªán. (NƒÉng l·ª±c th·∫•p, Cam k·∫øt th·∫•p)' };
        }
    }
    
    function getLeadershipStyleInfo(sLevel) {
        switch (sLevel) {
            case 'S1':
                return { title: 'S1: Ch·ªâ ƒë·∫°o (H√†nh vi ch·ªâ ƒë·∫°o cao, h·ªó tr·ª£ th·∫•p)', chuDich: 'Gi√∫p nh√¢n vi√™n ph√°t tri·ªÉn nƒÉng l·ª±c.', bangCach: [ 'Ghi nh·∫≠n c√°c k·ªπ nƒÉng c√≥ th·ªÉ chuy·ªÉn giao/h·ªçc cam k·∫øt.', 'ƒê∆∞a ra ch·ªâ ƒë·∫°o v·ªÅ c√¥ng vi·ªác, c√°ch l√†m v√† th·ªùi ƒëi·ªÉm ho√†n th√†nh.', 'Ki·ªÉm tra th∆∞·ªùng xuy√™n.' ] };
            case 'S2':
                return { title: 'S2: Hu·∫•n luy·ªán (H√†nh vi ch·ªâ ƒë·∫°o cao, h·ªó tr·ª£ cao)', chuDich: 'X·ªëc tinh th·∫ßn v√† ch·ªâ d·∫°y l·∫°i.', bangCach: [ 'Quan t√¢m ƒë·∫øn h·ªç v√† kh√≠ch l·ªá h·ªç.', 'Gi·∫£i th√≠ch v√¨ sao.', 'Ch·ªâ ƒë·∫°o v√† h∆∞·ªõng d·∫´n l·∫°i.', 'Cho h·ªç c√πng tham gia gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ.' ] };
            case 'S3':
                return { title: 'S3: H·ªó tr·ª£ (H√†nh vi ch·ªâ ƒë·∫°o th·∫•p, h·ªó tr·ª£ cao)', chuDich: 'X√¢y d·ª±ng s·ª± t·ª± tin v√†o nƒÉng l·ª±c.', bangCach: [ 'N√≥i D3 ƒë∆∞a √Ω ki·∫øn v·ªÅ c√¥ng vi·ªác ƒë∆∞·ª£c giao v√† c√°ch l√†m.', 'L·∫Øng nghe v√† kh√≠ch l·ªá.', 'H∆∞·ªõng d·∫´n gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ b·∫±ng c√°ch ƒë·∫∑t c√¢u h·ªèi m·ªü.' ] };
            case 'S4':
                return { title: 'S4: Giao ph√≥ (H√†nh vi ch·ªâ ƒë·∫°o th·∫•p, h·ªó tr·ª£ th·∫•p)', chuDich: 'Tr√¢n tr·ªçng s·ª± ƒë√≥ng g√≥p.', bangCach: [ 'Ghi nh·∫≠n h·ªç c√≥ chuy√™n m√¥n.', '·ª¶ng h·ªô s·ª± t·ª± quy·∫øt.', 'Khuy·∫øn kh√≠ch h·ªç ƒë·ªïi m·ªõi v√† h·ªçc h·ªèi li√™n t·ª•c.' ] };
            default:
                return { title: '', chuDich: '', bangCach: [] };
        }
    }

    function renderStramAnalysis(data) {
        const container = document.getElementById('stramAnalysisContainer');
        let tableHtml = `
            <table class="stram-table">
                <thead>
                    <tr>
                        <th>H·∫°ng</th>
                        <th>Nh√¢n vi√™n</th>
                        <th>NƒÉng l·ª±c (DT DK)</th>
                        <th>Cam k·∫øt (Tƒê DK)</th>
                        <th>C·∫•p ƒë·ªô (T·ªïng th·ªÉ)</th>
                        <th>Phong c√°ch QL</th>
                        <th>Chi ti·∫øt</th>
                    </tr>
                </thead>
                <tbody>`;
        
        data.forEach(e => {
            const stram = getOverallDevelopmentLevel(e.projectedRevenueCompletion, e.overallProjectedContestCompletion);
            const nangLucPercent = stram.revenuePercent;
            const nangLucHigh = nangLucPercent >= 95;
            const nangLucCell = `<div style="text-align: center; min-width: 100px;">
                                    <span style="color: ${nangLucHigh ? 'var(--success-color)' : 'var(--danger-color)'}; font-weight: 700; font-size: 1.1em;">
                                        ${nangLucPercent.toFixed(1)}%
                                    </span>
                                    <div class="stram-progress-bar-bg">
                                        <div class="stram-progress-bar-fill ${nangLucHigh ? 'success' : 'danger'}" style="width: ${Math.min(100, nangLucPercent)}%;"></div>
                                    </div>
                               </div>`;
            const camKetPercent = stram.overallProjectedContestCompletion; 
            const camKetHigh = camKetPercent >= 80;
            const camKetCell = `<div style="text-align: center; min-width: 100px;">
                                    <span style="color: ${camKetHigh ? 'var(--success-color)' : 'var(--danger-color)'}; font-weight: 700; font-size: 1.1em;">
                                        ${camKetPercent.toFixed(1)}%
                                    </span>
                                    <div class="stram-progress-bar-bg">
                                        <div class="stram-progress-bar-fill ${camKetHigh ? 'success' : 'danger'}" style="width: ${Math.min(100, camKetPercent)}%;"></div>
                                    </div>
                               </div>`;
            
            tableHtml += `
                <tr>
                    <td class="rank-cell">${e.rank}</td>
                    <td>${abbreviateName(e.name)}</td>
                    <td>${nangLucCell}</td>
                    <td>${camKetCell}</td>
                    <td><span class="d-level-badge ${stram.dLevel.toLowerCase()}">${stram.dLevel}</span></td>
                    <td><span class="s-level-badge ${stram.sLevel.toLowerCase()}">${stram.sLevel}</span></td>
                    <td>
                        <button class="btn-stram-detail" onclick="showStramDetailsPopup('${e.id}')">
                            Xem chi ti·∫øt
                        </button>
                    </td>
                </tr>
            `;
        });
        container.innerHTML = tableHtml + '</tbody></table>';
    }

    function showStramDetailsPopup(employeeId) {
        const employeeData = finalData.find(emp => emp.id === employeeId);
        if (!employeeData) return;

        const modal = document.getElementById('stram-modal');
        const modalTitle = document.getElementById('stram-modal-title');
        const modalBody = document.getElementById('stram-modal-body');
        
        modalTitle.textContent = `Ph√¢n t√≠ch STRAM: ${employeeData.name}`;
        const overall = getOverallDevelopmentLevel(employeeData.projectedRevenueCompletion, employeeData.overallProjectedContestCompletion);
        const leaderStyle = getLeadershipStyleInfo(overall.sLevel);
        const revenueTask = getTaskDevelopmentLevel(employeeData.projectedRevenueCompletion);
        
        const contestTasks = Object.entries(employeeData.contestCompletion)
            .filter(([name]) => sortedContestHeadersGlobal.includes(name))
            .map(([name, data]) => {
                return { name, rawData: data, analysis: getTaskDevelopmentLevel(data.projectedPercent) };
            })
            .sort((a, b) => b.rawData.projectedPercent - a.rawData.projectedPercent);
        
        let contestTaskHtml = contestTasks.map((task, index) => {
            const leaderAction = getLeadershipStyleInfo(task.analysis.sLevel);
            const data = task.rawData;
            const contestTimeframe = getContestTimeframe(task.name);
            
            const remaining = data.target - data.actual;
            const remainingDays = contestTimeframe.remainingDays; 
            const isTargetCompleted = data.actual >= data.target;

            // M·ª•c ti√™u ng√†y: C√≤n l·∫°i / S·ªë ng√†y c√≤n l·∫°i (ch·ªâ t√≠nh n·∫øu c√≤n l·∫°i > 0 v√† c√≤n ng√†y)
            const todayTarget = (remaining > 0 && remainingDays > 0) ? remaining / remainingDays : 0;
            
            // Icon Cup: D√πng Cup n·∫øu Target ƒë√£ ho√†n th√†nh
            const targetTodayCell = isTargetCompleted ? `<span class="value green">üèÜ</span>` : `<span class="value">${formatNumberFull(todayTarget, 2)}</span>`;
            const remainingCell = isTargetCompleted ? `<span class="value green">üèÜ</span>` : `<span class="value">${formatNumberFull(remaining, 2)}</span>`;
            
            const projectedPercentClass = data.projectedPercent >= 100 ? 'green' : (data.projectedPercent >= 80 ? 'green' : (data.projectedPercent >= 50 ? 'red' : 'red'));
            
            return `
                <tr>
                    <td>${index + 1}</td>
                    <td style="text-align: left; vertical-align: top;">
                        <strong style="font-size: 1.1em; color: var(--text-primary);">${task.name}</strong>
                        <div class="stram-task-details">
                            <div><span class="label">M.ti√™u Ng√†y:</span> ${targetTodayCell}</div>
                            <div><span class="label">Target:</span> <span class="value">${formatNumberFull(data.target, 0)}</span></div>
                            <div><span class="label">L≈©y k·∫ø:</span> <span class="value">${formatNumberFull(data.actual, 2)}</span></div>
                            <div><span class="label">C√≤n l·∫°i:</span> ${remainingCell}</div>
                            <div><span class="label">% HT:</span> <span class="value">${data.percent.toFixed(0)}%</span></div>
                            <div><span class="label">% HT DK:</span> <span class="value ${projectedPercentClass}">${data.projectedPercent.toFixed(1)}%</span></div>
                        </div>
                    </td>
                    <td><span class="d-level-badge ${task.analysis.dLevel.toLowerCase()}">${task.analysis.dLevel}</span></td>
                    <td><span class="s-level-badge ${task.analysis.sLevel.toLowerCase()}">${task.analysis.sLevel}</span></td>
                    <td style="text-align: left; font-size: 13px; vertical-align: top;">
                        <strong>${leaderAction.chuDich}</strong>
                        <ul>${leaderAction.bangCach.map(li => `<li>${li}</li>`).join('')}</ul>
                    </td>
                </tr>
            `;
        }).join('');
        
        const revenueActual = employeeData.actual_DTQD || 0;
        const revenueTarget = employeeData.revenueTarget || 0;
        const revenueRemaining = revenueTarget - revenueActual;
        const timeframe = getContestTimeframe('');
        
        const remainingDaysRevenue = timeframe.remainingDays;
        const isRevenueTargetCompleted = revenueActual >= revenueTarget;
        
        // M·ª•c ti√™u ng√†y: C√≤n l·∫°i / S·ªë ng√†y c√≤n l·∫°i (ch·ªâ t√≠nh n·∫øu c√≤n l·∫°i > 0 v√† c√≤n ng√†y)
        const revenueTodayTarget = (revenueRemaining > 0 && remainingDaysRevenue > 0) ? revenueRemaining / remainingDaysRevenue : 0;
        
        const revenueTodayCell = isRevenueTargetCompleted ? `<span class="value green">üèÜ</span>` : `<span class="value">${formatNumberFull(revenueTodayTarget, 0)}</span>`;
        const revenueRemainingCell = isRevenueTargetCompleted ? `<span class="value green">‚úÖ</span>` : `<span class="value">${formatNumberFull(revenueRemaining, 0)}</span>`;
        
        const projectedPercentClass = employeeData.projectedRevenueCompletion >= 100 ? 'green' : (employeeData.projectedRevenueCompletion >= 80 ? 'green' : (employeeData.projectedRevenueCompletion >= 50 ? 'red' : 'red'));

        let revenueTaskHtml = `
            <tr>
                <td style="text-align: left; vertical-align: top;">
                    <strong style="font-size: 1.1em; color: var(--text-primary);">Doanh thu C√° nh√¢n</strong>
                    <div class="stram-task-details">
                        <div><span class="label">M.ti√™u Ng√†y:</span> ${revenueTodayCell}</div>
                        <div><span class="label">Target:</span> <span class="value">${formatNumberFull(revenueTarget, 0)}</span></div>
                        <div><span class="label">L≈©y k·∫ø:</span> <span class="value">${formatNumberFull(revenueActual, 0)}</span></div>
                        <div><span class="label">C√≤n l·∫°i:</span> ${revenueRemainingCell}</div>
                        <div><span class="label">% HT:</span> <span class="value">${employeeData.revenueCompletion.toFixed(0)}%</span></div>
                        <div><span class="label">% HT DK:</span> <span class="value ${projectedPercentClass}">${employeeData.projectedRevenueCompletion.toFixed(1)}%</span></div>
                    </div>
                </td>
                <td><span class="d-level-badge ${revenueTask.dLevel.toLowerCase()}">${revenueTask.dLevel}</span></td>
                <td><span class="s-level-badge ${revenueTask.sLevel.toLowerCase()}">${revenueTask.sLevel}</span></td>
                <td style="text-align: left; font-size: 13px; vertical-align: top;">
                    <strong>${getLeadershipStyleInfo(revenueTask.sLevel).chuDich}</strong>
                    <ul>${getLeadershipStyleInfo(revenueTask.sLevel).bangCach.map(li => `<li>${li}</li>`).join('')}</ul>
                </td>
            </tr>
        `;

        modalBody.innerHTML = `
            <style>
                #stram-modal .modal-content { max-width: 1200px; }
                .stram-task-table { table-layout: fixed; width: 100%; }
                .stram-task-table th, .stram-task-table td { word-wrap: break-word; font-size: 12px; padding: 12px 8px; }
                #tab-contest .stram-task-table th:nth-child(1), #tab-contest .stram-task-table td:nth-child(1) { width: 5%; }
                #tab-contest .stram-task-table th:nth-child(2), #tab-contest .stram-task-table td:nth-child(2) { width: 35%; text-align: left; }
                #tab-contest .stram-task-table th:nth-child(3), #tab-contest .stram-task-table td:nth-child(3) { width: 8%; }
                #tab-contest .stram-task-table th:nth-child(4), #tab-contest .stram-task-table td:nth-child(4) { width: 8%; }
                #tab-contest .stram-task-table th:nth-child(5), #tab-contest .stram-task-table td:nth-child(5) { width: 44%; text-align: left; }
                #tab-revenue .stram-task-table th:nth-child(1), #tab-revenue .stram-task-table td:nth-child(1) { width: 35%; text-align: left; }
                #tab-revenue .stram-task-table th:nth-child(2), #tab-revenue .stram-task-table td:nth-child(2) { width: 8%; }
                #tab-revenue .stram-task-table th:nth-child(3), #tab-revenue .stram-task-table td:nth-child(3) { width: 8%; }
                #tab-revenue .stram-task-table th:nth-child(4), #tab-revenue .stram-task-table td:nth-child(4) { width: 49%; text-align: left; }
            </style>
            <div class="stram-modal-grid">
                <div class="stram-leader-card">
                    <h3>Chu·∫©n ƒëo√°n T·ªïng th·ªÉ</h3>
                    <p style="font-size: 1.1em; text-align: center;">
                        <span class="d-level-badge ${overall.dLevel.toLowerCase()}">${overall.dLevel}</span>
                        <span style="font-size: 1.5em; margin: 0 10px;">‚ûî</span>
                        <span class="s-level-badge ${overall.sLevel.toLowerCase()}">${overall.sLevel}</span>
                    </p>
                    <p style="font-size: 14px; text-align: center; color: var(--text-muted); margin-top: 5px;"><i>"${overall.description}"</i></p>
                    <hr style="border: none; border-top: 1px solid var(--border-main); margin: 15px 0;">
                    <h3>G·ª£i √Ω Phong c√°ch L√£nh ƒë·∫°o Chung</h3>
                    <h4>${leaderStyle.title}</h4>
                    <h4>Ch·ªß ƒë√≠ch:</h4>
                    <p style="font-size: 14px; color: var(--text-muted);">${leaderStyle.chuDich}</p>
                    <h4>B·∫±ng c√°ch:</h4>
                    <ul>${leaderStyle.bangCach.map(item => `<li>${item}</li>`).join('')}</ul>
                </div>
                <div>
                    <div class="stram-tabs">
                        <button class="stram-tab-btn active" data-tab="tab-contest">Thi ƒëua (${contestTasks.length})</button>
                        <button class="stram-tab-btn" data-tab="tab-revenue">Doanh thu</button>
                    </div>
                    <div id="tab-contest" class="stram-tab-content active" style="max-height: 60vh; overflow-y: auto;">
                        <table class="stram-task-table">
                            <thead><tr><th>STT</th><th>Nhi·ªám v·ª• (Ng√†nh h√†ng) & Chi ti·∫øt</th><th>C·∫•p ƒë·ªô (D)</th><th>Phong c√°ch (S)</th><th>G·ª£i √Ω H√†nh ƒë·ªông</th></tr></thead>
                            <tbody>${contestTaskHtml}</tbody>
                        </table>
                    </div>
                    <div id="tab-revenue" class="stram-tab-content">
                         <table class="stram-task-table">
                            <thead><tr><th>Nhi·ªám v·ª• & Chi ti·∫øt</th><th>C·∫•p ƒë·ªô (D)</th><th>Phong c√°ch (S)</th><th>G·ª£i √Ω H√†nh ƒë·ªông</th></tr></thead>
                            <tbody>${revenueTaskHtml}</tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        
        modalBody.querySelectorAll('.stram-tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                modalBody.querySelectorAll('.stram-tab-btn').forEach(b => b.classList.remove('active'));
                modalBody.querySelectorAll('.stram-tab-content').forEach(c => c.classList.remove('active'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab).classList.add('active');
            });
        });
        modal.style.display = 'block';
    }

    // Popup Logic
    function showEmployeeDetailsPopup(employeeId, event) {
        event.preventDefault(); 
        const employeeData = finalData.find(emp => emp.id === employeeId);
        if (employeeData) {
            const contestData = Object.entries(employeeData.contestCompletion).filter(([name]) => sortedContestHeadersGlobal.includes(name)).sort(([, a], [, b]) => b.projectedPercent - a.projectedPercent);
            let tableHtml = `
                <div class="card" style="margin:0; box-shadow: none; border: none;">
                    <h3 style="margin-top:0; color: var(--primary-color);">Chi ti·∫øt Thi ƒëua: ${employeeData.name}</h3>
                    <div class="table-container" style="margin-top:15px; max-height: 60vh;">
                        <table class="data-table"><thead><tr><th>#</th><th>Ng√†nh h√†ng</th><th>L≈©y k·∫ø</th><th>Target</th><th>% HT</th><th>% HT D·ª± ki·∫øn</th></tr></thead><tbody>`;
            contestData.forEach(([name, data], index) => {
                const percentClass = getPercentColorClass(data.percent);
                const projectedClass = getPercentColorClass(data.projectedPercent);
                tableHtml += `<tr><td style="font-weight:bold;">${index + 1}</td><td>${name}</td><td>${formatNumberFull(data.actual, 2)}</td><td>${formatNumberFull(data.target, 0)}</td><td class="${percentClass}">${data.percent.toFixed(0)}%</td><td class="${projectedClass}">${data.projectedPercent.toFixed(1)}%</td></tr>`;
            });
            tableHtml += `</tbody></table></div></div>`;
            document.getElementById('modal-body').innerHTML = tableHtml;
            document.getElementById('kpi-modal').style.display = 'block';
        }
    }
    
    function showContestDetailsPopup(contestName, event) {
        event.preventDefault();
        const decodedContestName = decodeURIComponent(contestName);
        if (!sortedContestHeadersGlobal.includes(decodedContestName)) return showToast(`Ng√†nh h√†ng "${decodedContestName}" hi·ªán kh√¥ng ƒë∆∞·ª£c hi·ªÉn th·ªã.`);
        const sortedByContest = [...finalData].sort((a, b) => {
            const perfA = a.contestCompletion[decodedContestName]?.projectedPercent || 0;
            const perfB = b.contestCompletion[decodedContestName]?.projectedPercent || 0;
            return perfB - perfA;
        });
        let tableHtml = `
            <div class="card" style="margin:0; box-shadow: none; border: none;">
                <h3 style="margin-top:0; color: var(--primary-color);">X·∫øp h·∫°ng Ng√†nh h√†ng: ${decodedContestName}</h3>
                <div class="table-container" style="margin-top:15px; max-height: 60vh;">
                    <table class="data-table"><thead><tr><th>H·∫°ng</th><th>Nh√¢n vi√™n</th><th>L≈©y k·∫ø</th><th>Target</th><th>% HT</th><th>% HT D·ª± ki·∫øn</th></tr></thead><tbody>`;
        sortedByContest.forEach((employee, index) => {
            const item = employee.contestCompletion[decodedContestName] || { actual: 0, target: 0, percent: 0, projectedPercent: 0 };
            const percentClass = getPercentColorClass(item.percent);
            const projectedClass = getPercentColorClass(item.projectedPercent);
            tableHtml += `<tr><td class="rank-cell">${index + 1}</td><td>${employee.name}</td><td>${formatNumberFull(item.actual, 2)}</td><td>${formatNumberFull(item.target, 0)}</td><td class="${percentClass}">${item.percent.toFixed(0)}%</td><td class="${projectedClass}">${item.projectedPercent.toFixed(1)}%</td></tr>`;
        });
        tableHtml += `</tbody></table></div></div>`;
        document.getElementById('modal-body').innerHTML = tableHtml; 
        document.getElementById('kpi-modal').style.display = 'block';
    }

    function exportContestSelection() { /* ... */ }
    function importContestSelection() { /* ... */ }
    function applyContestSelection() { document.getElementById('contest-selection-modal').style.display = 'none'; processData(true); }
    function showContestSelectionModal() {
        if(allContestHeadersGlobal.length===0) return showToast("Vui l√≤ng x·ª≠ l√Ω d·ªØ li·ªáu tr∆∞·ªõc.");
        const list = document.getElementById('contest-list');
        list.innerHTML = allContestHeadersGlobal.map(c => `<div class="contest-item" onclick="toggleCheckboxInModal(event, 'chk-${c}')"><input type="checkbox" id="chk-${c}" value="${c}" ${selectedContestHeaders.includes(c)?'checked':''}> <label>${c}</label></div>`).join('');
        document.getElementById('contest-selection-modal').style.display = 'block';
    }
    function toggleCheckboxInModal(e, id) { e.stopPropagation(); const cb = document.getElementById(id); cb.checked = !cb.checked; }
    function toggleAllModalContests(chk) { document.querySelectorAll('#contest-list input').forEach(c => c.checked = chk); selectedContestHeaders = chk ? [...allContestHeadersGlobal] : []; }
    </script>
</body>
</html>